/*******************************************************************************
 *
 *  Copyright (c)  2011 Toura, LLC.	All Rights Reserved.
 *  http://toura.com
 *
 *  LICENSE: https://github.com/Toura/mulberry/blob/master/LICENSE.txt
 *
 *******************************************************************************/
dojo.provide("mulberry.base");if(!dojo._hasResource["mulberry.app.Config"]){dojo._hasResource["mulberry.app.Config"]=true;dojo.provide("mulberry.app.Config");(function(d,_1){var _2={};mulberry.app.Config={get:function(_3){return _2[_3];},set:function(_4,_5){_2=_2||{};_2[_4]=_5;},registerConfig:function(_6){_2=_6||{};}};if(mulberry._Config){mulberry.app.Config.registerConfig(mulberry._Config);}}(dojo));}if(!dojo._hasResource["mulberry.Device"]){dojo._hasResource["mulberry.Device"]=true;dojo.provide("mulberry.Device");mulberry._loadDeviceConfig=function(){function _7(){var _8=dojo.body(),_9=Math.min(_8.offsetWidth,_8.offsetHeight);return _9>640?"tablet":"phone";};mulberry.Device=mulberry.app.Config.get("device")||{type:_7(),os:"browser"};};mulberry._loadDeviceConfig();}if(!dojo._hasResource["mulberry._Logging"]){dojo._hasResource["mulberry._Logging"]=true;dojo.provide("mulberry._Logging");(function(d,w,c){var _a,_b="=====",_c;function _d(ts){var _e="";if(!_c){_c=ts;}else{_e=" ("+(ts-_c)+"ms since last log) ";_c=ts;}return _e;};d.mixin(mulberry,{log:function(){var _f=[].slice.call(arguments);if(w.device){console.log("\n\n "+new Date().getTime()+" "+_f.join(" ")+"\n\n");}else{c.log.apply(c,_f);}},logSection:function(_10){var ts=new Date().getTime();console.log((w.device?"\n":"")+_b+"\n"+ts+"   START "+_10+_d(ts)+"\n"+_b);},endLogSection:function(_11){var ts=new Date().getTime();console.log((w.device?"\n":"")+_b+"\n"+ts+"   END   "+_11+_d(ts)+"\n"+_b);}});}(dojo,window,console));}if(!dojo._hasResource["mulberry._PageDef"]){dojo._hasResource["mulberry._PageDef"]=true;dojo.provide("mulberry._PageDef");mulberry.pageDefs=mulberry.pageDefs||{};dojo.declare("mulberry._PageDef",null,{constructor:function(_12){if(!_12.screens||!_12.screens.length){throw "Page definition must include at least one screen";}dojo.forEach(_12.screens,function(_13){if(!_13.regions||!_13.regions.length){throw "Page definition must include at least one region per screen";}});dojo.mixin(this,_12);}});mulberry.pageDef=function(_14,_15){mulberry.pageDefs[_14]=new mulberry._PageDef(_15);};}if(!dojo._hasResource["dojo.store.util.QueryResults"]){dojo._hasResource["dojo.store.util.QueryResults"]=true;dojo.provide("dojo.store.util.QueryResults");dojo.getObject("store.util",true,dojo);dojo.store.util.QueryResults=function(_16){if(!_16){return _16;}if(_16.then){_16=dojo.delegate(_16);}function _17(_18){if(!_16[_18]){_16[_18]=function(){var _19=arguments;return dojo.when(_16,function(_1a){Array.prototype.unshift.call(_19,_1a);return dojo.store.util.QueryResults(dojo[_18].apply(dojo,_19));});};}};_17("forEach");_17("filter");_17("map");if(!_16.total){_16.total=dojo.when(_16,function(_1b){return _1b.length;});}return _16;};}if(!dojo._hasResource["dojo.store.util.SimpleQueryEngine"]){dojo._hasResource["dojo.store.util.SimpleQueryEngine"]=true;dojo.provide("dojo.store.util.SimpleQueryEngine");dojo.getObject("store.util",true,dojo);dojo.store.util.SimpleQueryEngine=function(_1c,_1d){switch(typeof _1c){default:throw new Error("Can not query with a "+typeof _1c);case "object":case "undefined":var _1e=_1c;_1c=function(_1f){for(var key in _1e){var _20=_1e[key];if(_20&&_20.test){if(!_20.test(_1f[key])){return false;}}else{if(_20!=_1f[key]){return false;}}}return true;};break;case "string":if(!this[_1c]){throw new Error("No filter function "+_1c+" was found in store");}_1c=this[_1c];case "function":}function _21(_22){var _23=dojo.filter(_22,_1c);if(_1d&&_1d.sort){_23.sort(function(a,b){for(var _24,i=0;_24=_1d.sort[i];i++){var _25=a[_24.attribute];var _26=b[_24.attribute];if(_25!=_26){return !!_24.descending==_25>_26?-1:1;}}return 0;});}if(_1d&&(_1d.start||_1d.count)){var _27=_23.length;_23=_23.slice(_1d.start||0,(_1d.start||0)+(_1d.count||Infinity));_23.total=_27;}return _23;};_21.matches=_1c;return _21;};}if(!dojo._hasResource["dojo.store.Memory"]){dojo._hasResource["dojo.store.Memory"]=true;dojo.provide("dojo.store.Memory");dojo.declare("dojo.store.Memory",null,{constructor:function(_28){this.index={};dojo.mixin(this,_28);this.setData(this.data||[]);},data:null,idProperty:"id",index:null,queryEngine:dojo.store.util.SimpleQueryEngine,get:function(id){return this.index[id];},getIdentity:function(_29){return _29[this.idProperty];},put:function(_2a,_2b){var id=_2b&&_2b.id||_2a[this.idProperty]||Math.random();this.index[id]=_2a;var _2c=this.data,_2d=this.idProperty;for(var i=0,l=_2c.length;i<l;i++){if(_2c[i][_2d]==id){_2c[i]=_2a;return id;}}this.data.push(_2a);return id;},add:function(_2e,_2f){if(this.index[_2f&&_2f.id||_2e[this.idProperty]]){throw new Error("Object already exists");}return this.put(_2e,_2f);},remove:function(id){delete this.index[id];var _30=this.data,_31=this.idProperty;for(var i=0,l=_30.length;i<l;i++){if(_30[i][_31]==id){_30.splice(i,1);return;}}},query:function(_32,_33){return dojo.store.util.QueryResults(this.queryEngine(_32,_33)(this.data));},setData:function(_34){if(_34.items){this.idProperty=_34.identifier;_34=this.data=_34.items;}else{this.data=_34;}for(var i=0,l=_34.length;i<l;i++){var _35=_34[i];this.index[_35[this.idProperty]]=_35;}}});}if(!dojo._hasResource["mulberry._Store"]){dojo._hasResource["mulberry._Store"]=true;dojo.provide("mulberry._Store");dojo.declare("mulberry._Store",dojo.store.Memory,{add:function(_36){_36=this._createModel(_36);this.put(_36);},get:function(id){var _37=this.inherited(arguments);return this._createModel(_37);},put:function(_38){this.inherited(arguments);this._save();},remove:function(id){this.inherited(arguments);this._save();},query:function(_39,_3a){var _3b=_39?this.inherited(arguments):dojo.store.util.QueryResults(this.data);return _3b.map(dojo.hitch(this,"_createModel"));},setData:function(_3c){this.inherited(arguments);this._save();},prepareData:function(_3d){return _3d;},process:function(_3e){_3e=this.prepareData(_3e);if(this.model&&client.models[this.model]){_3e=this._createModels(_3e);}return _3e;},invoke:function(ids,fn){ids=dojo.isArray(ids)?ids:[ids];var _3f=dojo.map(ids,function(id){var _40=this.get(id);dojo.hitch(_40,fn)(_40);this.put(_40);return _40;},this);return dojo.store.util.QueryResults(_3f);},_createModel:function(_41){if(this.model&&client.models[this.model]){_41=new client.models[this.model](_41);_41.format();}else{console.warn("No model for "+this.declaredClass);}if(!_41.id){_41.id=this._createId();}return _41;},_createModels:function(_42){return dojo.map(_42,dojo.hitch(this,"_createModel"));},_save:function(){mulberry.app.DeviceStorage.set(this.key,this.data);},_createId:function(){return (((1+Math.random())*65536)).toString(16).substring(1);}});mulberry.store=function(_43,_44){dojo.declare("client.stores."+_43,mulberry._Store,dojo.mixin({key:_43,data:mulberry.app.DeviceStorage.get(_43)},_44));client.stores[_43]=new client.stores[_43]();};}if(!dojo._hasResource["mulberry._Model"]){dojo._hasResource["mulberry._Model"]=true;dojo.provide("mulberry._Model");dojo.declare("mulberry._Model",dojo.Stateful,{format:function(){}});mulberry.model=function(_45,_46){dojo.declare("client.models."+_45,mulberry._Model,_46);};}if(!dojo._hasResource["mulberry.Utilities"]){dojo._hasResource["mulberry.Utilities"]=true;dojo.provide("mulberry.Utilities");dojo.forIn=function(obj,fn,_47){var k;for(k in obj){if(obj.hasOwnProperty(k)){dojo.hitch(_47||window,fn)(k,obj[k]);}}};mulberry.util={truncate:function(_48,len){var _49;len=len||200;_48=_48.replace("</p>"," ").replace("<br>"," ").replace(/(<\/.>)|(<.>)|(<[^b][^r]?[^>]*>)/g,"");_49=_48=dojo.trim(_48);_48=_48.substr(0,len);if(_48&&_49.length>len){_48=_48+" &hellip;";}return _48;},copyStyles:function(_4a,_4b,_4c){var _4d=window.getComputedStyle(_4a);dojo.forEach(_4c,function(_4e){dojo.style(_4b,_4e,_4d[_4e]);});}};mulberry.tmpl=function(str,_4f){return dojo.string.substitute(str,_4f);};mulberry.haml=Haml;mulberry.jsonp=function(url,_50){_50=dojo.isObject(url)?url:(_50||{});_50.callbackParamName=_50.callback||_50.callbackParamName||"callback";url=dojo.isString(url)?url:_50.url;if(!url){return;}return dojo.io.script.get(dojo.delegate(_50,{url:url}));};mulberry.page=function(_51,_52,_53){mulberry.route(_51,function(_54){mulberry.showPage(mulberry.createPage(dojo.mixin(_52,{params:_54})));},_53);};}if(!dojo._hasResource["mulberry.app.URL"]){dojo._hasResource["mulberry.app.URL"]=true;dojo.provide("mulberry.app.URL");mulberry.app.URL={protocol:function(){return (/^https/).test(document.location.protocol)?"https":"http";},tel:function(tel){return "tel:"+tel.replace(/\W/g,"");},googleMapAddress:function(_55){var url="http://maps.google.com/maps?",_56={q:_55};return url+dojo.objectToQuery(_56);}};}if(!dojo._hasResource["mulberry.app.PhoneGap.notification"]){dojo._hasResource["mulberry.app.PhoneGap.notification"]=true;dojo.provide("mulberry.app.PhoneGap.notification");mulberry.app.PhoneGap.notification=function(pg,_57){return {alert:function(msg){if(pg){navigator.notification.alert(msg);}else{alert(msg);}}};};}if(!dojo._hasResource["mulberry.app.PhoneGap.device"]){dojo._hasResource["mulberry.app.PhoneGap.device"]=true;dojo.provide("mulberry.app.PhoneGap.device");(function(){function _58(ua){if(!ua){return "unknown";}if(!dojo.isString(ua)){return "unknown";}if(!dojo.trim(ua)){return "unknown";}var v;if(ua.match("Android")){v=dojo.trim(ua.split("Android")[1].split(";")[0]).split("-")[0].split(".");return _59(v);}if(ua.indexOf("AppleWebKit")>-1&&(ua.indexOf("iPhone")+ua.indexOf("iPad")+ua.indexOf("iPod"))>=0){return "unknown-ios-webkit";}return "unknown";};function _59(_5a){return [_5a[0],_5a[1]||"0"].join("-");};mulberry.app.PhoneGap.device=function(pg,_5b){return {version:(function(){if(pg){return _59(window.device.version.split("-")[0].split("."));}return _58(window.navigator.userAgent);}()),_parseVersion:_58};};}());}if(!dojo._hasResource["mulberry.app.PhoneGap.network"]){dojo._hasResource["mulberry.app.PhoneGap.network"]=true;dojo.provide("mulberry.app.PhoneGap.network");mulberry.app.PhoneGap.network=function(pg,_5c){var n=navigator,_5d=5*60*1000,_5e,_5f,_60;return {isReachable:function(){console.log("mulberry.app.PhoneGap.network::isReachable()");var dfd=new dojo.Deferred(),now=new Date().getTime();if(_5f&&!_60&&(now-_5f<_5d)){dfd.resolve(_60);return dfd;}_5f=now;if(navigator.network&&navigator.network.connection){_5e=navigator.network.connection.type;if(_5e===Connection.UNKNOWN||_5e===Connection.NONE){_60=false;}else{_60=true;}}else{_60=true;}dfd.resolve(_60);return dfd.promise;},state:function(){var _61={},_62;if(navigator.network&&navigator.network.connection){_61[Connection.UNKNOWN]="Unknown connection";_61[Connection.ETHERNET]="Ethernet connection";_61[Connection.WIFI]="WiFi connection";_61[Connection.CELL_2G]="Cell 2G connection";_61[Connection.CELL_3G]="Cell 3G connection";_61[Connection.CELL_4G]="Cell 4G connection";_61[Connection.NONE]="No network connection";_62=navigator.network.connection.type;return {state:_62,description:_61[_62]};}else{return {state:-1,description:"Unknown connection"};}}};};}if(!dojo._hasResource["mulberry.app.PhoneGap.audio"]){dojo._hasResource["mulberry.app.PhoneGap.audio"]=true;dojo.provide("mulberry.app.PhoneGap.audio");mulberry.app.PhoneGap.audio=function(pg,_63){var _64,_65=function(){},_66=function(err){};return {play:function(url){console.log("mulberry.app.PhoneGap.audio::play()");if(!pg){return;}url=/^http/.test(url)?url:("/android_asset/www/"+url);_64=new Media(url,_65,_66);_64.play();},stop:function(){console.log("mulberry.app.PhoneGap.audio::stop()");if(!pg||!_64){return;}_64.pause();},destroy:function(){if(!_64){return;}_64.stop();_64.release();_64=null;}};};}if(!dojo._hasResource["vendor.urbanairship.push"]){dojo._hasResource["vendor.urbanairship.push"]=true;dojo.provide("vendor.urbanairship.push");vendor.urbanairship.push=function(){var _67=function(){};_67.prototype.register=function(_68,_69,_6a){PhoneGap.exec(_68,_69,"PushNotification","registerAPN",_6a);};_67.prototype.startNotify=function(_6b){PhoneGap.exec(null,null,"PushNotification","startNotify",[]);};_67.prototype.log=function(_6c){PhoneGap.exec(null,null,"PushNotification","log",[{"msg":_6c}]);};PhoneGap.addConstructor(function(){if(!window.plugins){window.plugins={};}window.plugins.pushNotification=new _67();});};}if(!dojo._hasResource["mulberry.app.PhoneGap.push"]){dojo._hasResource["mulberry.app.PhoneGap.push"]=true;dojo.provide("mulberry.app.PhoneGap.push");mulberry.app.PhoneGap.push=function(pg,_6d){if(!pg){return;}vendor.urbanairship.push();};}if(!dojo._hasResource["mulberry.app.PhoneGap.browser"]){dojo._hasResource["mulberry.app.PhoneGap.browser"]=true;dojo.provide("mulberry.app.PhoneGap.browser");mulberry.app.PhoneGap.browser=function(pg,_6e){function _6f(){};window.ChildBrowser=_6f;var os=_6e.os,_70={ios:function(){_6f._onLocationChange=function(_71){window.plugins.childBrowser.onLocationChange(_71);};_6f._onClose=function(){window.plugins.childBrowser.onClose();};_6f._onOpenExternal=function(){window.plugins.childBrowser.onOpenExternal();};_6f._onJSCallback=function(js,loc){};_6f.prototype.showWebPage=function(loc){PhoneGap.exec("ChildBrowserCommand.showWebPage",loc);};_6f.prototype.close=function(){PhoneGap.exec("ChildBrowserCommand.close");};_6f.prototype.jsExec=function(_72){};_6f.install=function(){if(!window.plugins){window.plugins={};}window.plugins.childBrowser=new _6f();return window.plugins.childBrowser;};_6f.install();},android:function(){_6f.prototype.showWebPage=function(url,_73){PhoneGap.exec(null,null,"ChildBrowser","showWebPage",[url,_73]);};PhoneGap.addConstructor(function(){PhoneGap.addPlugin("childBrowser",new _6f());PluginManager.addService("ChildBrowser","com.phonegap.plugins.childBrowser.ChildBrowser");});}};if(pg&&_70[os]){_70[os]();}return {url:function(url){if(pg){if(os==="android"){PhoneGap.exec(null,null,"ChildBrowser","showWebPage",[url,false]);}else{window.plugins.childBrowser.showWebPage(url);}return;}window.location=url;},getBrowser:function(){if(!window.plugins.childBrowser){throw new Error("Can't find childBrowser plugin");}return window.plugins.childBrowser;}};};}if(!dojo._hasResource["mulberry.app.PhoneGap.camera"]){dojo._hasResource["mulberry.app.PhoneGap.camera"]=true;dojo.provide("mulberry.app.PhoneGap.camera");mulberry.app.PhoneGap.camera=function(pg,_74){var _75=function(){};return {getPicture:function(_76,_77,_78){if(!dojo.isFunction(_76)){_78=_76;_76=false;_77=false;}var dfd=new dojo.Deferred(),win=function(_79){(_76||_75)(_79);dfd.resolve(_79);},_7a=function(msg){(_77||_75)(msg);dfd.reject(msg);};if(pg&&navigator&&navigator.camera){navigator.camera.getPicture(win,_7a,_78);}else{dfd.resolve();}return dfd.promise;}};};}if(!dojo._hasResource["mulberry.app.PhoneGap.geolocation"]){dojo._hasResource["mulberry.app.PhoneGap.geolocation"]=true;dojo.provide("mulberry.app.PhoneGap.geolocation");mulberry.app.PhoneGap.geolocation=function(pg,_7b){var _7c=function(){};return {getCurrentPosition:function(_7d,_7e,_7f){if(!dojo.isFunction(_7d)){_7f=_7d;_7d=false;_7e=false;}var dfd=new dojo.Deferred(),win=function(_80){(_7d||_7c)(_80);dfd.resolve(_80);},_81=function(msg){(_7e||_7c)(msg);dfd.reject(msg);},_82="Geolocation API not available";if(navigator.geolocation&&navigator.geolocation.getCurrentPosition){navigator.geolocation.getCurrentPosition(win,_81,_7f);}else{_81(_82);}return dfd.promise;},watchPosition:function(_83,_84,_85){if(navigator.geolocation&&navigator.geolocation.watchPosition){return navigator.geolocation.watchPosition(_83,_84,_85);}return false;},clearWatch:function(_86){if(_86&&navigator.geolocation&&navigator.geolocation.clearWatch){navigator.geolocation.clearWatch(_86);}}};};}if(!dojo._hasResource["mulberry.app.PhoneGap.accelerometer"]){dojo._hasResource["mulberry.app.PhoneGap.accelerometer"]=true;dojo.provide("mulberry.app.PhoneGap.accelerometer");mulberry.app.PhoneGap.accelerometer=function(pg,_87){var _88=function(){};return {getCurrentAcceleration:function(_89,_8a){var dfd=new dojo.Deferred(),win=function(_8b){(_89||_88)(_8b);dfd.resolve(_8b);},_8c=function(msg){(_8a||_88)(msg);dfd.reject(msg);},_8d="Accelerometer API not available";if(navigator.accelerometer&&navigator.accelerometer.getCurrentAcceleration){navigator.accelerometer.getCurrentAcceleration(win,_8c);}else{_8c(_8d);}return dfd.promise;},watchAcceleration:function(_8e,_8f){if(navigator.accelerometer&&navigator.accelerometer.watchAcceleration){return navigator.accelerometer.watchAcceleration(_8e,_8f);}else{return false;}},clearWatch:function(_90){var _91=_90.watchId||_90;if(navigator.accelerometer&&navigator.accelerometer.clearWatch&&_91){navigator.accelerometer.clearWatch(_91);}}};};}if(!dojo._hasResource["mulberry.app.PhoneGap"]){dojo._hasResource["mulberry.app.PhoneGap"]=true;dojo.provide("mulberry.app.PhoneGap");(function(){mulberry.app.PhoneGap.registerAPI=function(_92,_93){var s=dojo.subscribe("/app/deviceready",function(){var _94=mulberry.Device,_95=mulberry.app.PhoneGap.present=window.device&&window.device.phonegap;console.log("NAME",_92);mulberry.app.PhoneGap[_92]=_93(_95,_94);dojo.unsubscribe(s);});};var _96=["notification","device","network","audio","push","browser","camera","geolocation","accelerometer"];dojo.forEach(_96,function(_97){mulberry.app.PhoneGap.registerAPI(_97,mulberry.app.PhoneGap[_97]);});}());}if(!dojo._hasResource["mulberry.app.DeviceStorage"]){dojo._hasResource["mulberry.app.DeviceStorage"]=true;dojo.provide("mulberry.app.DeviceStorage");mulberry.app.DeviceStorage=(function(){var _98={"tour":{tableName:"items",fields:["id text","json text"],insertStatement:function(_99,_9a){return ["INSERT INTO "+_99+"( id, json ) VALUES ( ?, ? )",[_9a.id,JSON.stringify(_9a)]];},processSelecton:function(_9b){var _9c=[],len=_9b.rows.length,_9d,i;for(i=0;i<len;i++){_9d=_9b.rows.item(i).json;_9c.push(_9d?JSON.parse(_9d):{});}return _9c;}}};return {init:function(_9e){this.appId=_9e;if(!window.localStorage){throw new Error("Local storage interface is not defined. Cannot create database. Aborting.");}if(!window.openDatabase){throw new Error("SQLite database interface is not defined. Cannot create database. Aborting.");}var db=this._db=openDatabase(_9e+"-"+mulberry.version,"1.0",_9e+" Database",5*1024*1024);if(!db){console.log("No database. This will end badly.");}this._sql=function(_9f,_a0){var dfd=new dojo.Deferred(),len;_9f=dojo.isArray(_9f)?_9f:[_9f];len=_9f.length;db.transaction(function(t){dojo.forEach(_9f,function(q,i){var _a1=i+1===len,cb,eb,_a2=[];if(_a1){cb=dojo.isFunction(_a0)?function(t,_a3){dfd.callback(_a0(_a3));}:dfd.callback;eb=dfd.errback;}else{cb=eb=function(){};}if(dojo.isArray(q)){_a2=q[1];q=q[0];}t.executeSql(q,_a2,cb,eb);});});return dfd;};return this._db;},drop:function(){var _a4=[];dojo.forIn(_98,function(_a5,_a6){_a4.push("DROP TABLE IF EXISTS "+_a6.tableName);});window.localStorage.clear();return this._sql(_a4);},set:function(k,v){var sql=_98[k],_a7;if(sql){_a7=["DROP TABLE IF EXISTS "+sql.tableName,"CREATE TABLE "+sql.tableName+"("+sql.fields.join(",")+")"];dojo.forEach(v,function(_a8){_a7.push(sql.insertStatement(sql.tableName,_a8));});return this._sql(_a7);}window.localStorage.setItem(k,JSON.stringify(v));return true;},get:function(k){var sql=_98[k];if(sql){return this._sql("SELECT * FROM "+sql.tableName,sql.processSelecton);}var ret=window.localStorage.getItem(k);if(ret==="undefined"){ret=null;}ret=ret&&JSON.parse(ret);return ret;}};}());}if(!dojo._hasResource["mulberry._Nls"]){dojo._hasResource["mulberry._Nls"]=true;dojo.provide("mulberry._Nls");dojo.declare("mulberry._Nls",null,{data:{__initialized:false},constructor:function(){if(!this.data.__initialized){this.data.nlsStrings=dojo.i18n.getLocalization("mulberry","mulberry",mulberry.app.Config.get("locale"));this.data.__initialized=true;}},getString:function(key,_a9){var str=this.data.nlsStrings[key];return (_a9)?dojo.string.substitute(str,_a9):str;},postMixInProperties:function(){this.inherited("postMixInProperties",arguments);this.initializeStrings();},initializeStrings:function(){}});}if(!dojo._hasResource["vendor.iscroll"]){dojo._hasResource["vendor.iscroll"]=true;dojo.provide("vendor.iscroll");(function(){function _aa(el,_ab){var _ac=this,doc=document,div,i;_ac.wrapper=typeof el=="object"?el:doc.getElementById(el);_ac.wrapper.style.overflow="hidden";_ac.scroller=_ac.wrapper.children[0];_ac.options={HWTransition:true,HWCompositing:true,hScroll:true,vScroll:true,hScrollbar:true,vScrollbar:true,fixedScrollbar:_ad,fadeScrollbar:(_ae&&_af)||!_b0,hideScrollbar:_ae||!_b0,scrollbarClass:"",bounce:_af,bounceLock:false,momentum:_af,lockDirection:true,zoom:false,zoomMin:1,zoomMax:4,snap:false,pullToRefresh:false,pullDownLabel:["Pull down to refresh...","Release to refresh...","Loading..."],pullUpLabel:["Pull up to refresh...","Release to refresh...","Loading..."],onPullDown:function(){},onPullUp:function(){},onScrollStart:null,onScrollEnd:null,onZoomStart:null,onZoomEnd:null,checkDOMChange:false};for(i in _ab){_ac.options[i]=_ab[i];}_ac.options.HWCompositing=_ac.options.HWCompositing&&_10b;_ac.options.HWTransition=_ac.options.HWTransition&&_10b;if(_ac.options.HWCompositing){_ac.scroller.style.cssText+="-webkit-transition-property:-webkit-transform;-webkit-transform-origin:0 0;-webkit-transform:"+_b8+"0,0"+_b9;}else{_ac.scroller.style.cssText+="-webkit-transition-property:top,left;-webkit-transform-origin:0 0;top:0;left:0";}if(_ac.options.HWTransition){_ac.scroller.style.cssText+="-webkit-transition-timing-function:cubic-bezier(0.33,0.66,0.66,1);-webkit-transition-duration:0;";}_ac.options.hScrollbar=_ac.options.hScroll&&_ac.options.hScrollbar;_ac.options.vScrollbar=_ac.options.vScroll&&_ac.options.vScrollbar;_ac.pullDownToRefresh=_ac.options.pullToRefresh=="down"||_ac.options.pullToRefresh=="both";_ac.pullUpToRefresh=_ac.options.pullToRefresh=="up"||_ac.options.pullToRefresh=="both";if(_ac.pullDownToRefresh){div=doc.createElement("div");div.className="iScrollPullDown";div.innerHTML="<span class=\"iScrollPullDownIcon\"></span><span class=\"iScrollPullDownLabel\">"+_ac.options.pullDownLabel[0]+"</span>\n";_ac.scroller.insertBefore(div,_ac.scroller.children[0]);_ac.options.bounce=true;_ac.pullDownEl=div;_ac.pullDownLabel=div.getElementsByTagName("span")[1];}if(_ac.pullUpToRefresh){div=doc.createElement("div");div.className="iScrollPullUp";div.innerHTML="<span class=\"iScrollPullUpIcon\"></span><span class=\"iScrollPullUpLabel\">"+_ac.options.pullUpLabel[0]+"</span>\n";_ac.scroller.appendChild(div);_ac.options.bounce=true;_ac.pullUpEl=div;_ac.pullUpLabel=div.getElementsByTagName("span")[1];}_ac.refresh();_ac._bind(_b6,window);_ac._bind(_b2);if(_c6&&_ac.options.zoom){_ac._bind("gesturestart");_ac.scroller.style.webkitTransform=_ac.scroller.style.webkitTransform+" scale(1)";}if(!_b0){_ac._bind("mousewheel");}if(_ac.options.checkDOMChange){_ac.DOMChangeInterval=setInterval(function(){_ac._checkSize();},250);}};_aa.prototype={x:0,y:0,currPageX:0,currPageY:0,pagesX:[],pagesY:[],offsetBottom:0,offsetTop:0,scale:1,lastScale:1,contentReady:true,handleEvent:function(e){var _b1=this;switch(e.type){case _b2:_b1._start(e);break;case _b3:_b1._move(e);break;case _b4:case _b5:_b1._end(e);break;case "webkitTransitionEnd":_b1._transitionEnd(e);break;case _b6:_b1._resize();break;case "gesturestart":_b1._gestStart(e);break;case "gesturechange":_b1._gestChange(e);break;case "gestureend":case "gesturecancel":_b1._gestEnd(e);break;case "mousewheel":_b1._wheel(e);break;}},_scrollbar:function(dir){var _b7=this,doc=document,bar;if(!_b7[dir+"Scrollbar"]){if(_b7[dir+"ScrollbarWrapper"]){_b7[dir+"ScrollbarIndicator"].style.webkitTransform="";_b7[dir+"ScrollbarWrapper"].parentNode.removeChild(_b7[dir+"ScrollbarWrapper"]);_b7[dir+"ScrollbarWrapper"]=null;_b7[dir+"ScrollbarIndicator"]=null;}return;}if(!_b7[dir+"ScrollbarWrapper"]){bar=doc.createElement("div");if(_b7.options.scrollbarClass){bar.className=_b7.options.scrollbarClass+dir.toUpperCase();}else{bar.style.cssText="position:absolute;z-index:100;"+(dir=="h"?"height:7px;bottom:1px;left:2px;right:7px":"width:7px;bottom:7px;top:2px;right:1px");}bar.style.cssText+="pointer-events:none;-webkit-transition-property:opacity;-webkit-transition-duration:"+(_b7.options.fadeScrollbar?"350ms":"0")+";overflow:hidden;opacity:"+(_b7.options.hideScrollbar?"0":"1");_b7.wrapper.appendChild(bar);_b7[dir+"ScrollbarWrapper"]=bar;bar=doc.createElement("div");if(!_b7.options.scrollbarClass){bar.style.cssText="position:absolute;z-index:100;background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.9);-webkit-background-clip:padding-box;-webkit-box-sizing:border-box;"+(dir=="h"?"height:100%;-webkit-border-radius:4px 3px;":"width:100%;-webkit-border-radius:3px 4px;");}bar.style.cssText+="pointer-events:none;-webkit-transition-property:-webkit-transform;-webkit-transition-timing-function:cubic-bezier(0.33,0.66,0.66,1);-webkit-transition-duration:0;-webkit-transform:"+_b8+"0,0"+_b9;_b7[dir+"ScrollbarWrapper"].appendChild(bar);_b7[dir+"ScrollbarIndicator"]=bar;}if(dir=="h"){_b7.hScrollbarSize=_b7.hScrollbarWrapper.clientWidth;_b7.hScrollbarIndicatorSize=m.max(m.round(_b7.hScrollbarSize*_b7.hScrollbarSize/_b7.scrollerW),8);_b7.hScrollbarIndicator.style.width=_b7.hScrollbarIndicatorSize+"px";_b7.hScrollbarMaxScroll=_b7.hScrollbarSize-_b7.hScrollbarIndicatorSize;_b7.hScrollbarProp=_b7.hScrollbarMaxScroll/_b7.maxScrollX;}else{_b7.vScrollbarSize=_b7.vScrollbarWrapper.clientHeight;_b7.vScrollbarIndicatorSize=m.max(m.round(_b7.vScrollbarSize*_b7.vScrollbarSize/_b7.scrollerH),8);_b7.vScrollbarIndicator.style.height=_b7.vScrollbarIndicatorSize+"px";_b7.vScrollbarMaxScroll=_b7.vScrollbarSize-_b7.vScrollbarIndicatorSize;_b7.vScrollbarProp=_b7.vScrollbarMaxScroll/_b7.maxScrollY;}_b7._indicatorPos(dir,true);},_resize:function(){var _ba=this;setTimeout(function(){_ba.refresh();},0);},_checkSize:function(){var _bb=this,_bc,_bd;if(_bb.moved||_bb.zoomed||!_bb.contentReady){return;}_bc=m.round(_bb.scroller.offsetWidth*_bb.scale),_bd=m.round((_bb.scroller.offsetHeight-_bb.offsetBottom-_bb.offsetTop)*_bb.scale);if(_bc==_bb.scrollerW&&_bd==_bb.scrollerH){return;}_bb.refresh();},_pos:function(x,y){var _be=this;_be.x=_be.hScroll?x:0;_be.y=_be.vScroll?y:0;_be.scroller.style.webkitTransform=_b8+_be.x+"px,"+_be.y+"px"+_b9+" scale("+_be.scale+")";_be._indicatorPos("h");_be._indicatorPos("v");},_indicatorPos:function(dir,_bf){var _c0=this,pos=dir=="h"?_c0.x:_c0.y;if(!_c0[dir+"Scrollbar"]){return;}pos=_c0[dir+"ScrollbarProp"]*pos;if(pos<0){pos=_c0.options.fixedScrollbar?0:pos+pos*3;if(_c0[dir+"ScrollbarIndicatorSize"]+pos<9){pos=-_c0[dir+"ScrollbarIndicatorSize"]+8;}}else{if(pos>_c0[dir+"ScrollbarMaxScroll"]){pos=_c0.options.fixedScrollbar?_c0[dir+"ScrollbarMaxScroll"]:pos+(pos-_c0[dir+"ScrollbarMaxScroll"])*3;if(_c0[dir+"ScrollbarIndicatorSize"]+_c0[dir+"ScrollbarMaxScroll"]-pos<9){pos=_c0[dir+"ScrollbarIndicatorSize"]+_c0[dir+"ScrollbarMaxScroll"]-8;}}}_c0[dir+"ScrollbarWrapper"].style.webkitTransitionDelay="0";_c0[dir+"ScrollbarWrapper"].style.opacity=_bf&&_c0.options.hideScrollbar?"0":"1";_c0[dir+"ScrollbarIndicator"].style.webkitTransform=_b8+(dir=="h"?pos+"px,0":"0,"+pos+"px")+_b9;},_transitionTime:function(_c1){var _c2=this;_c1+="ms";_c2.scroller.style.webkitTransitionDuration=_c1;if(_c2.hScrollbar){_c2.hScrollbarIndicator.style.webkitTransitionDuration=_c1;}if(_c2.vScrollbar){_c2.vScrollbarIndicator.style.webkitTransitionDuration=_c1;}},_start:function(e){var _c3=this,_c4=_b0?e.changedTouches[0]:e,_c5;_c3.moved=false;e.preventDefault();if(_b0&&e.touches.length==2&&_c3.options.zoom&&_c6&&!_c3.zoomed){_c3.originX=m.abs(e.touches[0].pageX+e.touches[1].pageX-_c3.wrapperOffsetLeft*2)/2-_c3.x;_c3.originY=m.abs(e.touches[0].pageY+e.touches[1].pageY-_c3.wrapperOffsetTop*2)/2-_c3.y;}_c3.moved=false;_c3.distX=0;_c3.distY=0;_c3.absDistX=0;_c3.absDistY=0;_c3.dirX=0;_c3.dirY=0;_c3.returnTime=0;_c3._transitionTime(0);if(_c3.options.momentum){if(_c3.scrollInterval){clearInterval(_c3.scrollInterval);_c3.scrollInterval=null;}if(_c3.options.HWCompositing){_c5=new WebKitCSSMatrix(window.getComputedStyle(_c3.scroller,null).webkitTransform);if(_c5.m41!=_c3.x||_c5.m42!=_c3.y){_c3._unbind("webkitTransitionEnd");_c3._pos(_c5.m41,_c5.m42);}}else{_c5=window.getComputedStyle(_c3.scroller,null);if(_c3.x+"px"!=_c5.left||_c3.y+"px"!=_c5.top){_c3._unbind("webkitTransitionEnd");_c3._pos(_c5.left.replace(/[^0-9]/g)*1,_c5.top.replace(/[^0-9]/g)*1);}}}_c3.scroller.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.66,0.66,1)";if(_c3.hScrollbar){_c3.hScrollbarIndicator.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.66,0.66,1)";}if(_c3.vScrollbar){_c3.vScrollbarIndicator.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.66,0.66,1)";}_c3.startX=_c3.x;_c3.startY=_c3.y;_c3.pointX=_c4.pageX;_c3.pointY=_c4.pageY;_c3.startTime=e.timeStamp;if(_c3.options.onScrollStart){_c3.options.onScrollStart.call(_c3);}_c3._bind(_b3);_c3._bind(_b4);_c3._bind(_b5);},_move:function(e){if(_b0&&e.touches.length>1){return;}var _c7=this,_c8=_b0?e.changedTouches[0]:e,_c9=_c8.pageX-_c7.pointX,_ca=_c8.pageY-_c7.pointY,_cb=_c7.x+_c9,_cc=_c7.y+_ca;e.preventDefault();_c7.pointX=_c8.pageX;_c7.pointY=_c8.pageY;if(_cb>0||_cb<_c7.maxScrollX){_cb=_c7.options.bounce?_c7.x+(_c9/2.4):_cb>=0||_c7.maxScrollX>=0?0:_c7.maxScrollX;}if(_cc>0||_cc<_c7.maxScrollY){_cc=_c7.options.bounce?_c7.y+(_ca/2.4):_cc>=0||_c7.maxScrollY>=0?0:_c7.maxScrollY;if(_c7.options.pullToRefresh&&_c7.contentReady){if(_c7.pullDownToRefresh&&_cc>_c7.offsetBottom){_c7.pullDownEl.className="iScrollPullDown flip";_c7.pullDownLabel.innerText=_c7.options.pullDownLabel[1];}else{if(_c7.pullDownToRefresh&&_c7.pullDownEl.className.match("flip")){_c7.pullDownEl.className="iScrollPullDown";_c7.pullDownLabel.innerText=_c7.options.pullDownLabel[0];}}if(_c7.pullUpToRefresh&&_cc<_c7.maxScrollY-_c7.offsetTop){_c7.pullUpEl.className="iScrollPullUp flip";_c7.pullUpLabel.innerText=_c7.options.pullUpLabel[1];}else{if(_c7.pullUpToRefresh&&_c7.pullUpEl.className.match("flip")){_c7.pullUpEl.className="iScrollPullUp";_c7.pullUpLabel.innerText=_c7.options.pullUpLabel[0];}}}}if(_c7.absDistX<4&&_c7.absDistY<4){_c7.distX+=_c9;_c7.distY+=_ca;_c7.absDistX=m.abs(_c7.distX);_c7.absDistY=m.abs(_c7.distY);return;}if(_c7.options.lockDirection){if(_c7.absDistX>_c7.absDistY+3){_cc=_c7.y;_ca=0;}else{if(_c7.absDistY>_c7.absDistX+3){_cb=_c7.x;_c9=0;}}}_c7.moved=true;_c7._pos(_cb,_cc);_c7.dirX=_c9>0?-1:_c9<0?1:0;_c7.dirY=_ca>0?-1:_ca<0?1:0;if(e.timeStamp-_c7.startTime>300){_c7.startTime=e.timeStamp;_c7.startX=_c7.x;_c7.startY=_c7.y;}},_end:function(e){if(_b0&&e.touches.length!=0){return;}var _cd=this,_ce=_b0?e.changedTouches[0]:e,_cf,ev,_d0={dist:0,time:0},_d1={dist:0,time:0},_d2=e.timeStamp-_cd.startTime,_d3=_cd.x,_d4=_cd.y,_d5,_d6;_cd._unbind(_b3);_cd._unbind(_b4);_cd._unbind(_b5);if(_cd.zoomed){return;}if(!_cd.moved){if(_b0){if(_cd.doubleTapTimer&&_cd.options.zoom){clearTimeout(_cd.doubleTapTimer);_cd.doubleTapTimer=null;_cd.zoom(_cd.pointX,_cd.pointY,_cd.scale==1?2:1);}else{_cd.doubleTapTimer=setTimeout(function(){_cd.doubleTapTimer=null;_cf=_ce.target;while(_cf.nodeType!=1){_cf=_cf.parentNode;}ev=document.createEvent("MouseEvents");ev.initMouseEvent("click",true,true,e.view,1,_ce.screenX,_ce.screenY,_ce.clientX,_ce.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,0,null);ev._fake=true;_cf.dispatchEvent(ev);},_cd.options.zoom?250:0);}}_cd._resetPos();return;}if(_cd.pullDownToRefresh&&_cd.contentReady&&_cd.pullDownEl.className.match("flip")){_cd.pullDownEl.className="iScrollPullDown loading";_cd.pullDownLabel.innerText=_cd.options.pullDownLabel[2];_cd.scroller.style.marginTop="0";_cd.offsetBottom=0;_cd.refresh();_cd.contentReady=false;_cd.options.onPullDown();}if(_cd.pullUpToRefresh&&_cd.contentReady&&_cd.pullUpEl.className.match("flip")){_cd.pullUpEl.className="iScrollPullUp loading";_cd.pullUpLabel.innerText=_cd.options.pullUpLabel[2];_cd.scroller.style.marginBottom="0";_cd.offsetTop=0;_cd.refresh();_cd.contentReady=false;_cd.options.onPullUp();}if(_d2<300&&_cd.options.momentum){_d0=_d3?_cd._momentum(_d3-_cd.startX,_d2,-_cd.x,_cd.scrollerW-_cd.wrapperW+_cd.x,_cd.options.bounce?_cd.wrapperW:0):_d0;_d1=_d4?_cd._momentum(_d4-_cd.startY,_d2,-_cd.y,(_cd.maxScrollY<0?_cd.scrollerH-_cd.wrapperH+_cd.y:0),_cd.options.bounce?_cd.wrapperH:0):_d1;_d3=_cd.x+_d0.dist;_d4=_cd.y+_d1.dist;if((_cd.x>0&&_d3>0)||(_cd.x<_cd.maxScrollX&&_d3<_cd.maxScrollX)){_d0={dist:0,time:0};}if((_cd.y>0&&_d4>0)||(_cd.y<_cd.maxScrollY&&_d4<_cd.maxScrollY)){_d1={dist:0,time:0};}}if(_d0.dist||_d1.dist){_d5=m.max(m.max(_d0.time,_d1.time),10);if(_cd.options.snap){_d6=_cd._snap(_d3,_d4);_d3=_d6.x;_d4=_d6.y;_d5=m.max(_d6.time,_d5);}_cd.scrollTo(_d3,_d4,_d5);return;}if(_cd.options.snap){_d6=_cd._snap(_cd.x,_cd.y);if(_d6.x!=_cd.x||_d6.y!=_cd.y){_cd.scrollTo(_d6.x,_d6.y,_d6.time);}return;}_cd._resetPos();},_resetPos:function(_d7){var _d8=this,_d9=_d8.x,_da=_d8.y;if(_d8.x>=0){_d9=0;}else{if(_d8.x<_d8.maxScrollX){_d9=_d8.maxScrollX;}}if(_d8.y>=0||_d8.maxScrollY>0){_da=0;}else{if(_d8.y<_d8.maxScrollY){_da=_d8.maxScrollY;}}if(_d9==_d8.x&&_da==_d8.y){if(_d8.moved){if(_d8.options.onScrollEnd){_d8.options.onScrollEnd.call(_d8);}_d8.moved=false;}if(_d8.zoomed){if(_d8.options.onZoomEnd){_d8.options.onZoomEnd.call(_d8);}_d8.zoomed=false;}if(_d8.hScrollbar&&_d8.options.hideScrollbar){_d8.hScrollbarWrapper.style.webkitTransitionDelay="300ms";_d8.hScrollbarWrapper.style.opacity="0";}if(_d8.vScrollbar&&_d8.options.hideScrollbar){_d8.vScrollbarWrapper.style.webkitTransitionDelay="300ms";_d8.vScrollbarWrapper.style.opacity="0";}return;}if(_d7===undefined){_d7=200;}if(_d7){_d8.scroller.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.0,0.33,1)";if(_d8.hScrollbar){_d8.hScrollbarIndicator.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.0,0.33,1)";}if(_d8.vScrollbar){_d8.vScrollbarIndicator.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.0,0.33,1)";}}_d8.scrollTo(_d9,_da,_d7);},_timedScroll:function(_db,_dc,_dd){var _de=this,_df=_de.x,_e0=_de.y,_e1=(new Date).getTime(),_e2;_de._transitionTime(0);if(_de.scrollInterval){clearInterval(_de.scrollInterval);_de.scrollInterval=null;}_de.scrollInterval=setInterval(function(){var now=(new Date).getTime(),_e3,_e4;if(now>=_e1+_dd){clearInterval(_de.scrollInterval);_de.scrollInterval=null;_de._pos(_db,_dc);_de._transitionEnd();return;}now=(now-_e1)/_dd-1;_e2=m.sqrt(1-now*now);_e3=(_db-_df)*_e2+_df;_e4=(_dc-_e0)*_e2+_e0;_de._pos(_e3,_e4);},20);},_transitionEnd:function(e){var _e5=this;if(e){e.stopPropagation();}_e5._unbind("webkitTransitionEnd");_e5._resetPos(_e5.returnTime);_e5.returnTime=0;},_gestStart:function(e){var _e6=this;_e6._transitionTime(0);_e6.lastScale=1;if(_e6.options.onZoomStart){_e6.options.onZoomStart.call(_e6);}_e6._unbind("gesturestart");_e6._bind("gesturechange");_e6._bind("gestureend");_e6._bind("gesturecancel");},_gestChange:function(e){var _e7=this,_e8=_e7.scale*e.scale,x,y,_e9;_e7.zoomed=true;if(_e8<_e7.options.zoomMin){_e8=_e7.options.zoomMin;}else{if(_e8>_e7.options.zoomMax){_e8=_e7.options.zoomMax;}}_e9=_e8/_e7.scale;x=_e7.originX-_e7.originX*_e9+_e7.x;y=_e7.originY-_e7.originY*_e9+_e7.y;_e7.scroller.style.webkitTransform=_b8+x+"px,"+y+"px"+_b9+" scale("+_e8+")";_e7.lastScale=_e9;},_gestEnd:function(e){var _ea=this,_eb=_ea.scale,_ec=_ea.lastScale;_ea.scale=_eb*_ec;if(_ea.scale<_ea.options.zoomMin+0.05){_ea.scale=_ea.options.zoomMin;}else{if(_ea.scale>_ea.options.zoomMax-0.05){_ea.scale=_ea.options.zoomMax;}}_ec=_ea.scale/_eb;_ea.x=_ea.originX-_ea.originX*_ec+_ea.x;_ea.y=_ea.originY-_ea.originY*_ec+_ea.y;_ea.scroller.style.webkitTransform=_b8+_ea.x+"px,"+_ea.y+"px"+_b9+" scale("+_ea.scale+")";setTimeout(function(){_ea.refresh();},0);_ea._bind("gesturestart");_ea._unbind("gesturechange");_ea._unbind("gestureend");_ea._unbind("gesturecancel");},_wheel:function(e){var _ed=this,_ee=_ed.x+e.wheelDeltaX/12,_ef=_ed.y+e.wheelDeltaY/12;if(_ee>0){_ee=0;}else{if(_ee<_ed.maxScrollX){_ee=_ed.maxScrollX;}}if(_ef>0){_ef=0;}else{if(_ef<_ed.maxScrollY){_ef=_ed.maxScrollY;}}_ed.scrollTo(_ee,_ef,0);},_momentum:function(_f0,_f1,_f2,_f3,_f4){var _f5=this,_f6=0.0006,_f7=m.abs(_f0)/_f1,_f8=(_f7*_f7)/(2*_f6),_f9=0,_fa=0;if(_f0>0&&_f8>_f2){_fa=_f4/(6/(_f8/_f7*_f6));_f2=_f2+_fa;_f5.returnTime=800/_f4*_fa+100;_f7=_f7*_f2/_f8;_f8=_f2;}else{if(_f0<0&&_f8>_f3){_fa=_f4/(6/(_f8/_f7*_f6));_f3=_f3+_fa;_f5.returnTime=800/_f4*_fa+100;_f7=_f7*_f3/_f8;_f8=_f3;}}_f8=_f8*(_f0<0?-1:1);_f9=_f7/_f6;return {dist:_f8,time:m.round(_f9)};},_offset:function(el,_fb){var _fc=-el.offsetLeft,top=-el.offsetTop;if(!_fb){return {x:_fc,y:top};}while(el=el.offsetParent){_fc-=el.offsetLeft;top-=el.offsetTop;}return {x:_fc,y:top};},_snap:function(x,y){var _fd=this,i,l,_fe,_ff,_100,_101;_fe=_fd.pagesX.length-1;for(i=0,l=_fd.pagesX.length;i<l;i++){if(x>=_fd.pagesX[i]){_fe=i;break;}}if(_fe==_fd.currPageX&&_fe>0&&_fd.dirX<0){_fe--;}x=_fd.pagesX[_fe];_100=m.abs(x-_fd.pagesX[_fd.currPageX]);_100=_100?m.abs(_fd.x-x)/_100*500:0;_fd.currPageX=_fe;_fe=_fd.pagesY.length-1;for(i=0;i<_fe;i++){if(y>=_fd.pagesY[i]){_fe=i;break;}}if(_fe==_fd.currPageY&&_fe>0&&_fd.dirY<0){_fe--;}y=_fd.pagesY[_fe];_101=m.abs(y-_fd.pagesY[_fd.currPageY]);_101=_101?m.abs(_fd.y-y)/_101*500:0;_fd.currPageY=_fe;_ff=m.round(m.max(_100,_101))||200;return {x:x,y:y,time:_ff};},_bind:function(type,el){(el||this.scroller).addEventListener(type,this,false);},_unbind:function(type,el){(el||this.scroller).removeEventListener(type,this,false);},destroy:function(){var that=this;if(that.options.checkDOMChange){clearTimeout(that.DOMChangeInterval);}if(that.pullDownToRefresh){that.pullDownEl.parentNode.removeChild(that.pullDownEl);}if(that.pullUpToRefresh){that.pullUpEl.parentNode.removeChild(that.pullUpEl);}that.hScrollbar=false;that.vScrollbar=false;that._scrollbar("h");that._scrollbar("v");that.scroller.style.webkitTransform="";that._unbind("webkitTransitionEnd");that._unbind(_b6);that._unbind(_b2);that._unbind(_b3);that._unbind(_b4);that._unbind(_b5);if(that.options.zoom){that._unbind("gesturestart");that._unbind("gesturechange");that._unbind("gestureend");that._unbind("gesturecancel");}},refresh:function(){var that=this,pos=0,page=0,i,l,els,_102,_103,_104;if(that.pullDownToRefresh){_104=that.pullDownEl.className.match("loading");if(_104&&!that.contentReady){_102=that.scrollerH;that.contentReady=true;that.pullDownEl.className="iScrollPullDown";that.pullDownLabel.innerText=that.options.pullDownLabel[0];that.offsetBottom=that.pullDownEl.offsetHeight;that.scroller.style.marginTop=-that.offsetBottom+"px";}else{if(!_104){that.offsetBottom=that.pullDownEl.offsetHeight;that.scroller.style.marginTop=-that.offsetBottom+"px";}}}if(that.pullUpToRefresh){_104=that.pullUpEl.className.match("loading");if(_104&&!that.contentReady){_102=that.scrollerH;that.contentReady=true;that.pullUpEl.className="iScrollPullUp";that.pullUpLabel.innerText=that.options.pullUpLabel[0];that.offsetTop=that.pullUpEl.offsetHeight;that.scroller.style.marginBottom=-that.offsetTop+"px";}else{if(!_104){that.offsetTop=that.pullUpEl.offsetHeight;that.scroller.style.marginBottom=-that.offsetTop+"px";}}}that.wrapperW=that.wrapper.clientWidth;that.wrapperH=that.wrapper.clientHeight;if(!that.wrapperW||!that.wrapperH){return false;}that.scrollerW=m.round(that.scroller.offsetWidth*that.scale);that.scrollerH=m.round((that.scroller.offsetHeight-that.offsetBottom-that.offsetTop)*that.scale);that.maxScrollX=that.wrapperW-that.scrollerW;that.maxScrollY=that.wrapperH-that.scrollerH;that.dirX=0;that.dirY=0;that._transitionTime(0);that.hScroll=that.options.hScroll&&that.maxScrollX<0;that.vScroll=that.options.vScroll&&(!that.options.bounceLock&&!that.hScroll||that.scrollerH>that.wrapperH);that.hScrollbar=that.hScroll&&that.options.hScrollbar;that.vScrollbar=that.vScroll&&that.options.vScrollbar&&that.scrollerH>that.wrapperH;that._scrollbar("h");that._scrollbar("v");if(typeof that.options.snap=="string"){that.pagesX=[];that.pagesY=[];els=that.scroller.querySelectorAll(that.options.snap);for(i=0,l=els.length;i<l;i++){pos=that._offset(els[i]);that.pagesX[i]=pos.x<that.maxScrollX?that.maxScrollX:pos.x*that.scale;that.pagesY[i]=pos.y<that.maxScrollY?that.maxScrollY:pos.y*that.scale;}}else{if(that.options.snap){that.pagesX=[];while(pos>=that.maxScrollX){that.pagesX[page]=pos;pos=pos-that.wrapperW;page++;}if(that.maxScrollX%that.wrapperW){that.pagesX[that.pagesX.length]=that.maxScrollX-that.pagesX[that.pagesX.length-1]+that.pagesX[that.pagesX.length-1];}pos=0;page=0;that.pagesY=[];while(pos>=that.maxScrollY){that.pagesY[page]=pos;pos=pos-that.wrapperH;page++;}if(that.maxScrollY%that.wrapperH){that.pagesY[that.pagesY.length]=that.maxScrollY-that.pagesY[that.pagesY.length-1]+that.pagesY[that.pagesY.length-1];}}}if(that.options.zoom){_103=that._offset(that.wrapper,true);that.wrapperOffsetLeft=-_103.x;that.wrapperOffsetTop=-_103.y;}if(_102&&that.y==0){_102=_102-that.scrollerH+that.y;that.scrollTo(0,_102,0);}that._resetPos();},scrollTo:function(x,y,time,_105){var that=this;if(_105){x=that.x-x;y=that.y-y;}time=!time||(m.round(that.x)==m.round(x)&&m.round(that.y)==m.round(y))?0:time;that.moved=true;if(!that.options.HWTransition){that._timedScroll(x,y,time);return;}if(time){that._bind("webkitTransitionEnd");}that._transitionTime(time);that._pos(x,y);if(!time){setTimeout(function(){that._transitionEnd();},0);}},scrollToElement:function(el,time){var that=this,pos;el=el.nodeType?el:that.scroller.querySelector(el);if(!el){return;}pos=that._offset(el);pos.x=pos.x>0?0:pos.x<that.maxScrollX?that.maxScrollX:pos.x;pos.y=pos.y>0?0:pos.y<that.maxScrollY?that.maxScrollY:pos.y;time=time===undefined?m.max(m.abs(pos.x)*2,m.abs(pos.y)*2):time;that.scrollTo(pos.x,pos.y,time);},scrollToPage:function(_106,_107,time){var that=this,x,y;if(that.options.snap){_106=_106=="next"?that.currPageX+1:_106=="prev"?that.currPageX-1:_106;_107=_107=="next"?that.currPageY+1:_107=="prev"?that.currPageY-1:_107;_106=_106<0?0:_106>that.pagesX.length-1?that.pagesX.length-1:_106;_107=_107<0?0:_107>that.pagesY.length-1?that.pagesY.length-1:_107;that.currPageX=_106;that.currPageY=_107;x=that.pagesX[_106];y=that.pagesY[_107];}else{x=-that.wrapperW*_106;y=-that.wrapperH*_107;if(x<that.maxScrollX){x=that.maxScrollX;}if(y<that.maxScrollY){y=that.maxScrollY;}}that.scrollTo(x,y,time||400);},zoom:function(x,y,_108,_109){var that=this,_10a=_108/that.scale;x=x-that.wrapperOffsetLeft-that.x;y=y-that.wrapperOffsetTop-that.y;that.x=x-x*_10a+that.x;that.y=y-y*_10a+that.y;that.scale=_108;if(that.options.onZoomStart){that.options.onZoomStart.call(that);}that.refresh();that._bind("webkitTransitionEnd");that._transitionTime(_109!==null?_109:200);setTimeout(function(){that.zoomed=true;that.scroller.style.webkitTransform=_b8+that.x+"px,"+that.y+"px"+_b9+" scale("+_108+")";},0);}};var _af="WebKitCSSMatrix" in window&&"m11" in new WebKitCSSMatrix(),_b0="ontouchstart" in window,_c6="ongesturestart" in window,_10b="WebKitTransitionEvent" in window,_ae=(/iphone|ipad/gi).test(navigator.appVersion),_ad=(/android/gi).test(navigator.appVersion),_b6="onorientationchange" in window?"orientationchange":"resize",_b2=_b0?"touchstart":"mousedown",_b3=_b0?"touchmove":"mousemove",_b4=_b0?"touchend":"mouseup",_b5=_b0?"touchcancel":"mouseup",_b8="translate"+(_af?"3d(":"("),_b9=_af?",0)":")",m=Math;if(typeof exports!=="undefined"){exports.iScroll=_aa;}else{window.iScroll=_aa;}})();}if(!dojo._hasResource["mulberry.ui.Scrollable"]){dojo._hasResource["mulberry.ui.Scrollable"]=true;dojo.provide("mulberry.ui.Scrollable");dojo.declare("mulberry.ui.Scrollable",dijit._Widget,{postCreate:function(){this.inherited(arguments);this.subscribe("/page/transition/end","_makeScroller");this.subscribe("/window/resize","refreshScroller");this.subscribe("/fontsize","refreshScroller");this.subscribe("/content/update",function(){this.refreshScroller();if(this.scroller){this.scroller.scrollTo(0,0);}});dojo.addClass(this.domNode,"scrollable");},_makeScroller:function(){if(this.domNode.children.length>1){console.error("mulberry.ui.Scrollable::_makeScroller: More than one child element. Only the first one will be scrollable. Probably not what you want!");}this.scroller=new iScroll(this.domNode,{vScrollbar:false,onScrollStart:dojo.hitch(this,"onScrollStart"),onScrollEnd:dojo.hitch(this,"onScrollEnd")});this.scroller.refresh();},makeScroller:function(){if(!this.scroller){this._makeScroller();}},destroy:function(){if(this.scroller){this.scroller.destroy();}this.inherited(arguments);},refreshScroller:function(){if(this.scroller){this.scroller.refresh();}},onScrollStart:function(){},onScrollEnd:function(){}});}if(!dojo._hasResource["mulberry.ui.Clickable"]){dojo._hasResource["mulberry.ui.Clickable"]=true;dojo.provide("mulberry.ui.Clickable");dojo.declare("mulberry.ui.Clickable",null,{constructor:function(el,_10c){this.connections=[];this.secondaryConnections=[];this.subscriptions=[];this.handler=_10c;this.el=el;this.moved=false;dojo.addClass(this.el,"not-moving");if(mulberry.app.UI.hasTouch){this.connections.push(dojo.connect(el,"touchstart",this,"_onTouchStart"));this.connections.push(dojo.connect(el,"click",function(e){e.preventDefault();}));}else{this.connections.push(dojo.connect(el,"click",this,"_handle"));}},_onTouchStart:function(){this.touchStartTime=new Date().getTime();this.secondaryConnections=[dojo.connect(this.el,"touchmove",this,"_onTouchMove"),dojo.connect(this.el,"touchend",this,"_handle")];},_onTouchMove:function(){dojo.removeClass(this.el,"not-moving");this.moved=true;},_handle:function(e){this.touchEndTime=new Date().getTime();dojo.addClass(this.el,"not-moving");dojo.forEach(this.secondaryConnections||[],dojo.disconnect);this.secondaryConnections=[];if(mulberry.animating){e.preventDefault();console.log("click ignored during animation");return;}var _10d=e.target,href=dojo.attr(_10d,"href");if(this.touchStartTime&&(this.touchEndTime-this.touchStartTime>mulberry.app.UI.touchMoveDebounce)&&this.moved){this.moved=false;return;}while(!href&&_10d!==this.el){href=dojo.attr(_10d,"href");if(!href){_10d=_10d.parentNode;}}if(!href){return;}if(this.handler&&dojo.isFunction(this.handler)&&this.handler(_10d,e)===false){return;}if(!/#/.test(href)){return;}href=href.split("#")[1];if(href){e.preventDefault();e.stopPropagation();mulberry.app.Router.go(href);}},destroy:function(){dojo.forEach(this.connections||[],dojo.disconnect);dojo.forEach(this.secondaryConnections||[],dojo.disconnect);dojo.forEach(this.subscriptions||[],dojo.unsubscribe);}});}if(!dojo._hasResource["vendor.mustache"]){dojo._hasResource["vendor.mustache"]=true;dojo.provide("vendor.mustache");var Mustache=(typeof module!=="undefined"&&module.exports)||{};(function(_10e){_10e.name="mustache.js";_10e.version="0.5.0-dev";_10e.tags=["{{","}}"];_10e.parse=_10f;_10e.compile=_110;_10e.render=_111;_10e.clearCache=_112;_10e.to_html=_111;var _113=Object.prototype.toString;var _114=Array.isArray;var _115=Array.prototype.forEach;var _116=String.prototype.trim;var _117;if(_114){_117=_114;}else{_117=function(obj){return _113.call(obj)==="[object Array]";};}var _118;if(_115){_118=function(obj,_119,_11a){return _115.call(obj,_119,_11a);};}else{_118=function(obj,_11b,_11c){for(var i=0,len=obj.length;i<len;++i){_11b.call(_11c,obj[i],i,obj);}};}var _11d=/^\s*$/;function _11e(_11f){return _11d.test(_11f);};var trim;if(_116){trim=function(_120){return _120==null?"":_116.call(_120);};}else{var _121,_122;if(_11e(" ")){_121=/^\s+/;_122=/\s+$/;}else{_121=/^[\s\xA0]+/;_122=/[\s\xA0]+$/;}trim=function(_123){return _123==null?"":String(_123).replace(_121,"").replace(_122,"");};}var _124={"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};function _125(_126){return String(_126).replace(/&(?!\w+;)|[<>"']/g,function(s){return _124[s]||s;});};function _127(e,_128,line,file){file=file||"<template>";var _129=_128.split("\n"),_12a=Math.max(line-3,0),end=Math.min(_129.length,line+3),_12b=_129.slice(_12a,end);var c;for(var i=0,len=_12b.length;i<len;++i){c=i+_12a+1;_12b[i]=(c===line?" >> ":"    ")+_12b[i];}e.template=_128;e.line=line;e.file=file;e.message=[file+":"+line,_12b.join("\n"),"",e.message].join("\n");return e;};function _12c(name,_12d,_12e){if(name==="."){return _12d[_12d.length-1];}var _12f=name.split(".");var _130=_12f.length-1;var _131=_12f[_130];var _132,_133,i=_12d.length,j,_134;while(i){_134=_12d.slice(0);_133=_12d[--i];j=0;while(j<_130){_133=_133[_12f[j++]];if(_133==null){break;}_134.push(_133);}if(_133&&_131 in _133){_132=_133[_131];break;}}if(typeof _132==="function"){_132=_132.call(_134[_134.length-1]);}if(_132==null&&!_12e){return "";}return _132;};function _135(send,name,_136,_137,_138){var _139=_12c(name,_137,true);if(_138){if(_139==null||_139===false||(_117(_139)&&_139.length===0)){send(_136());}}else{if(_117(_139)){_118(_139,function(_13a){_137.push(_13a);send(_136());_137.pop();});}else{if(typeof _139==="object"){_137.push(_139);send(_136());_137.pop();}else{if(typeof _139==="function"){var _13b=_137[_137.length-1];var _13c=function(_13d){return _111(_13d,_13b);};send(_139.call(_13b,_136(),_13c)||"");}else{if(_139){send(_136());}}}}}};function _10f(_13e,_13f){_13f=_13f||{};var tags=_13f.tags||_10e.tags,_140=tags[0],_141=tags[tags.length-1];var code=["var line = 1;","\ntry {","\nsend(\""];var _142=[],_143=false,_144=false;var _145=function(){if(_143&&!_144&&!_13f.space){while(_142.length){code.splice(_142.pop(),1);}}else{_142=[];}_143=false;_144=false;};var _146=[],_147,_148,_149;var _14a=function(_14b){tags=trim(_14b).split(/\s+/);_148=tags[0];_149=tags[tags.length-1];};var _14c=function(_14d){code.push("\");",_147,"\nvar partial = partials[\""+trim(_14d)+"\"];","\nif (partial) {","\n  send(render(partial, stack[stack.length - 1], partials));","\n}","\nsend(\"");};var _14e=function(_14f,_150){var name=trim(_14f);if(name===""){throw _127(new Error("Section name may not be empty"),_13e,line,_13f.file);}_146.push({name:name,inverted:_150});code.push("\");",_147,"\nvar name = \""+name+"\";","\nvar callback = (function () {","\n  var buffer, send = function (chunk) { buffer.push(chunk); };","\n  return function () {","\n    buffer = [];","\nsend(\"");};var _151=function(_152){_14e(_152,true);};var _153=function(_154){var name=trim(_154);var _155=_146.length!=0&&_146[_146.length-1].name;if(!_155||name!=_155){throw _127(new Error("Section named \""+name+"\" was never opened"),_13e,line,file);}var _156=_146.pop();code.push("\");","\n    return buffer.join(\"\");","\n  };","\n})();");if(_156.inverted){code.push("\nsendSection(send,name,callback,stack,true);");}else{code.push("\nsendSection(send,name,callback,stack);");}code.push("\nsend(\"");};var _157=function(_158){code.push("\");",_147,"\nsend(findName(\""+trim(_158)+"\", stack));","\nsend(\"");};var _159=function(_15a){code.push("\");",_147,"\nsend(escapeHTML(findName(\""+trim(_15a)+"\", stack)));","\nsend(\"");};var line=1,c,_15b;for(var i=0,len=_13e.length;i<len;++i){if(_13e.slice(i,i+_140.length)===_140){i+=_140.length;c=_13e.substr(i,1);_147="\nline = "+line+";";_148=_140;_149=_141;_143=true;switch(c){case "!":i++;_15b=null;break;case "=":i++;_141="="+_141;_15b=_14a;break;case ">":i++;_15b=_14c;break;case "#":i++;_15b=_14e;break;case "^":i++;_15b=_151;break;case "/":i++;_15b=_153;break;case "{":_141="}"+_141;case "&":i++;_144=true;_15b=_157;break;default:_144=true;_15b=_159;}var end=_13e.indexOf(_141,i);if(end===-1){throw _127(new Error("Tag \""+_140+"\" was not closed properly"),_13e,line,_13f.file);}var _15c=_13e.substring(i,end);if(_15b){_15b(_15c);}var n=0;while(~(n=_15c.indexOf("\n",n))){line++;n++;}i=end+_141.length-1;_140=_148;_141=_149;}else{c=_13e.substr(i,1);switch(c){case "\"":case "\\":_144=true;code.push("\\"+c);break;case "\n":_142.push(code.length);code.push("\\n");_145();line++;break;default:if(_11e(c)){_142.push(code.length);}else{_144=true;}code.push(c);}}}if(_146.length!=0){throw _127(new Error("Section \""+_146[_146.length-1].name+"\" was not closed properly"),_13e,line,_13f.file);}_145();code.push("\");","\nsend(null);","\n} catch (e) { throw {error: e, line: line}; }");var body=code.join("").replace(/send\(""\);\n/g,"");if(_13f.debug){if(typeof console!="undefined"&&console.log){console.log(body);}else{if(typeof print==="function"){print(body);}}}return body;};function _15d(_15e,_15f){var args="view,partials,send,stack,findName,escapeHTML,sendSection,render";var body=_10f(_15e,_15f);var fn=new Function(args,body);return function(view,_160,_161){if(typeof _160==="function"){_161=_160;_160={};}_160=_160||{};var _162=[];var send=_161||function(_163){_162.push(_163);};var _164=[view];try{fn(view,_160,send,_164,_12c,_125,_135,_111);}catch(e){throw _127(e.error,_15e,e.line,_15f.file);}return _162.join("");};};var _165={};function _112(){_165={};};function _110(_166,_167){_167=_167||{};if(_167.cache!==false){if(!_165[_166]){_165[_166]=_15d(_166,_167);}return _165[_166];}return _15d(_166,_167);};function _111(_168,view,_169,_16a){return _110(_168)(view,_169,_16a);};})(Mustache);}if(!dojo._hasResource["mulberry._View"]){dojo._hasResource["mulberry._View"]=true;dojo.provide("mulberry._View");(function(){var _16b={},_16c={"haml":{firstChars:[".","%"],tmplFn:Haml},"mustache":{firstChars:["{","<"],tmplFn:function(tmpl){return dojo.partial(Mustache.render,tmpl);}}};dojo.declare("mulberry._View",[dijit._Widget,dijit._Templated,mulberry._Nls],{templateString:"%div",isHidden:false,isDisabled:false,postMixInProperties:function(){this.inherited(arguments);if(!this.device){this.device=mulberry.Device;}this.phone=this.device.type==="phone";this.tablet=this.device.type==="tablet";},_skipNodeCache:true,_stringRepl:function(tmpl){var t=_16b[tmpl];if(!t){dojo.forIn(_16c,function(lang,_16d){if(t){return;}if(dojo.indexOf(_16d.firstChars,tmpl[0])>-1){t=_16b[tmpl]=_16d.tmplFn(tmpl);}});}return t(this);},postCreate:function(){this.inherited(arguments);},adopt:function(cls,_16e,node){var x=new cls(_16e,node);this._addItem(x);return x;},_addItem:function(){this._addedItems=this._addedItems||[];this._addedItems.push.apply(this._addedItems,arguments);},orphan:function(_16f,_170){this._addedItems=this._addedItems||[];var i=dojo.indexOf(this._addedItems,_16f);if(i>=0){this._addedItems.splice(i,1);}if(_170){this._kill(_16f);}},_kill:function(w){if(w&&w.destroyRecursive){w.destroyRecursive();}else{if(w&&w.destroy){w.destroy();}}},query:function(sel){var nl,_171;if(!sel){return new dojo.NodeList(this.domNode);}else{_171=this.domNode.querySelectorAll(sel);nl=new dojo.NodeList();dojo.forEach(_171,function(n){nl.push(n);});}return nl;},preventClickDelay:function(el,_172){this.clickables=this.clickables||[];this.clickables.push(new mulberry.ui.Clickable(el,dojo.hitch(this,_172)));},destroy:function(){dojo.forEach(this._addedItems,this._kill);dojo.forEach(this.scrollerHandles||[],function(_173){_173.destroy();});dojo.forEach(this.clickables||[],function(c){c.destroy();});this.inherited(arguments);},addClass:function(_174){dojo.addClass(this.domNode,_174);},removeClass:function(_175){dojo.removeClass(this.domNode,_175);},show:function(_176){if(_176&&_176.nodeName){dojo.removeClass(_176,"hidden");return;}this.removeClass("hidden");this.isHidden=false;},hide:function(_177){if(_177&&_177.nodeName){dojo.addClass(_177,"hidden");return;}this.addClass("hidden");this.isHidden=true;},toggle:function(_178){if(_178){dojo.toggleClass(_178,"hidden");return;}if(this.isHidden){this.show();}else{this.hide();}},enable:function(){this.removeClass("disabled");this.isDisabled=false;},disable:function(){this.addClass("disabled");this.isDisabled=true;}});}());}if(!dojo._hasResource["mulberry.containers.Viewport"]){dojo._hasResource["mulberry.containers.Viewport"]=true;dojo.provide("mulberry.containers.Viewport");dojo.declare("mulberry.containers.Viewport",mulberry._View,{templateString:dojo.cache("mulberry.containers","Viewport/Viewport.haml","%ol.viewport\n"),direction:"next",postCreate:function(){this.connect(this.domNode,"webkitAnimationEnd","_onAnimationEnd");},_setNavDirectionAttr:function(dir){this.direction=dir==="back"?"prev":"next";},_setContentAttr:function(_179){if(mulberry.animating){return;}var n=this.domNode,next=this.direction==="next";this.direction="next";this.currentPage=_179;if(n.children.length){mulberry.animating=true;this.addClass("pre-slide");_179.placeAt(n,next?"last":"first");this.addClass(next?"slide-left":"slide-right");}else{_179.placeAt(n,"last");this._onAnimationEnd();}setTimeout(function(){if(this.animating){this._onAnimationEnd();}},600);},_cleanupOldPage:function(){var _17a=document.querySelectorAll("ol.viewport > li");dojo.forEach(_17a,function(page){if(this.currentPage.domNode!==page){dojo.destroy(page);var _17b=dijit.byNode(page);if(_17b){_17b.destroy();}}},this);this.removeClass(["slide-left","slide-right","pre-slide"]);},_onAnimationEnd:function(){this._cleanupOldPage();mulberry.animating=false;dojo.publish("/page/transition/end");}});}if(!dojo._hasResource["mulberry._Component"]){dojo._hasResource["mulberry._Component"]=true;dojo.provide("mulberry._Component");dojo.declare("mulberry._Component",mulberry._View,{handleClicks:false,prepareData:function(){},setupConnections:function(){},setupSubscriptions:function(){},setupChildComponents:function(){},adjustMarkup:function(){},resizeElements:function(){},teardown:function(){},populate:function(_17c,data){this.populateElement(this.domNode,_17c,data);},populateElement:function(_17d,_17e,data){if(dojo.isString(_17d)){_17d=this[_17d];}if(!_17d){return;}_17d.innerHTML=dojo.isArray(data)?dojo.map(data,_17e).join(""):_17e(data);if(this.region){this.region.refreshScroller();}},postMixInProperties:function(){this.inherited(arguments);if(this.screen){this.screen.registerComponent(this);this.connect(this.screen,"startup","startup");}this.prepareData();this._loadHelpers();this.inherited(arguments);},postCreate:function(){this.inherited(arguments);if(this.isHidden){this.hide();}if(this.handleClicks){this.preventClickDelay(this.clickableNode||this.domNode,this._clickHandler&&dojo.hitch(this,"_clickHandler"));}this.subscribe("/window/resize",function(){this.dimensions=null;});this.setupChildComponents();this.adjustMarkup();this.setupConnections();this.setupSubscriptions();},startup:function(){this.inherited(arguments);this.resizeElements();if(this.when){dojo.forIn(this.when,function(k,v){var node=this.node||this.baseObj;node[k].then(dojo.hitch(this,v));},this);}},destroy:function(){this.teardown();this.inherited(arguments);},_loadHelpers:function(){if(this.helpers&&dojo.isObject(this.helpers)){dojo.forIn(this.helpers,function(prop,tpl){if(tpl){this.helpers[prop]=Haml(tpl)();}},this);}},_setupTouch:function(ele,_17f){var _180=mulberry.app.UI.hasTouch,evt=_180?"touchstart":"click";this.connect(ele,evt,_17f);if(_180){this.connect(ele,"click",function(e){e.preventDefault();});}},getDimensions:function(){var _181=this[this.sizeNode];this.dimensions=this.dimensions||{width:dojo.style(this.domNode,"width"),height:dojo.style(this.domNode,"height")};return this.dimensions;}});mulberry.component=function(name,_182){var p=dojo.mixin(_182,{templateString:_182.componentTemplate||"%div",prepareData:function(){this.inherited(arguments);if(_182.prep){_182.prep.call(this);}},postCreate:function(){this.inherited(arguments);if(window.jQuery){this.$domNode=jQuery(this.domNode);}},startup:function(){this.inherited(arguments);if(_182.init){_182.init.call(this);}}});dojo.declare("client.components."+name,mulberry._Component,p);};}if(!dojo._hasResource["toura.components.SiblingNav"]){dojo._hasResource["toura.components.SiblingNav"]=true;dojo.provide("toura.components.SiblingNav");dojo.declare("toura.components.SiblingNav",mulberry._Component,{templateString:dojo.cache("toura.components","SiblingNav/SiblingNav.haml",".component.sibling-nav\n  .handle{ dojoAttachPoint : 'handleNode' }\n    .toggler\n  %nav\n    .controller.prev{ dojoAttachPoint : 'prevButton' } prev\n    %ol.nodes{ dojoAttachPoint : 'siblingList' }\n    .controller.next{ dojoAttachPoint : 'nextButton' } next\n\n\n"),siblingTemplate:Haml(dojo.cache("toura.components","SiblingNav/Sibling.haml","%li{ class : className }\n  %span{ data-href : url }= name\n")),setupConnections:function(){var evt=mulberry.app.UI.hasTouch?"touchstart":"click";this.connect(this.handleNode,evt,"toggle");this.connect(this.prevButton,evt,dojo.hitch(this,"_handleButton","prev"));this.connect(this.nextButton,evt,dojo.hitch(this,"_handleButton","next"));this.connect(this.siblingList,evt,"_handleLink");},toggle:function(){this.set("open",!this.open);},_handleButton:function(dir){var node=this[dir+"Item"];if(dir==="prev"){mulberry.app.UI.set("navDirection","back");}mulberry.app.Router.go(node.url,true);},_handleLink:function(e){var _183=e.target,url=dojo.attr(_183,"data-href");if(!url){return;}if(dojo.hasClass(_183.parentNode,"prev")){mulberry.app.UI.set("navDirection","back");}mulberry.app.Router.go(url,true);},_setOpenAttr:function(open){dojo[open?"addClass":"removeClass"](this.domNode,"open");this.open=open;},_setNodeAttr:function(node){if(!node||!node.siblings||!node.siblings.length){this.hide();this.set("open",false);this.siblings=false;return;}this.show();this._processSiblings(node.siblings,node);},_processSiblings:function(_184,_185){this.siblings=_184.length?true:false;dojo.forEach(_184,function(_186,idx){if(_186.id===_185.id){this.currentIndex=idx;}},this);var _187=this.currentIndex+1;var _188=this.currentIndex-1;this.nextItem=_187>=_184.length?null:_184[_187];this.prevItem=_188<0?null:_184[_188];this._updateButtons();this._updateLinks();},_updateButtons:function(){dojo[this.nextItem?"removeClass":"addClass"](this.nextButton,"inactive");dojo[this.prevItem?"removeClass":"addClass"](this.prevButton,"inactive");},_updateLinks:function(){var html,_189;dojo.empty(this.siblingList);if(this.prevItem){_189=dojo.mixin(this.prevItem,{className:"prev"});this.prevLink=dojo.place(this.siblingTemplate(_189),this.siblingList);}if(this.nextItem){_189=dojo.mixin(this.nextItem,{className:"next"});this.nextLink=dojo.place(this.siblingTemplate(_189),this.siblingList);}}});}if(!dojo._hasResource["mulberry.app.UI"]){dojo._hasResource["mulberry.app.UI"]=true;dojo.provide("mulberry.app.UI");dojo.declare("mulberry.app.UI",dojo.Stateful,{containers:{},currentPage:null,constructor:function(_18a){this.device=_18a;this.body=dojo.body();this.hasTouch="ontouchstart" in window;this.touchMoveDebounce=_18a.os==="android"?200:0;this._navSetup();this._watchers();this._updateViewport();this._adSetup();this._uiSetup();this._eventSetup();this._containersSetup();},_watchers:function(){var _18b={fontSize:function(k,_18c,_18d){var b=this.body;if(_18c){dojo.removeClass(b,_18c);}dojo.addClass(b,_18d);mulberry.app.DeviceStorage.set("fontSize",_18d);dojo.publish("/fontsize");},navDirection:function(k,old,dir){this.containers.viewport.set("navDirection",dir);},siblingNavVisible:function(k,old,_18e){if(!this.siblingNav){return;}if(!this.siblingNav.siblings){this.siblingNav.hide();return;}this.siblingNav[_18e?"show":"hide"]();}};dojo.forIn(_18b,this.watch,this);},_updateViewport:function(){this.viewport={width:this.body.offsetWidth,height:this.body.offsetHeight};},_uiSetup:function(){var b=this.body,_18f=this.device,_190;dojo.addClass(b,_18f.type);dojo.addClass(b,_18f.os);dojo.addClass(b,"version-"+mulberry.app.PhoneGap.device.version);this.set("fontSize",mulberry.app.DeviceStorage.get("fontSize"));if(mulberry.features.multiLineChildNodes){dojo.addClass(b,"multi-line-child-nodes");}if(mulberry.isMAP){dojo.addClass(b,"layout-MAP");}dojo.forIn(mulberry.features,function(_191,_192){if(_192){dojo.addClass(b,"feature-"+_191);}});},_containersSetup:function(){this.containers.viewport=new mulberry.containers.Viewport().placeAt(this.body,"first");},_navSetup:function(){if(!mulberry.features.siblingNav){return;}this.siblingNav=new toura.components.SiblingNav().placeAt(this.body,"last");this.set("siblingNavVisible",false);},_adSetup:function(){if(!mulberry.features.ads){return;}mulberry.app.PhoneGap.network.isReachable().then(dojo.hitch(this,function(_193){if(!_193){return;}new toura.components.AdTag().placeAt(this.body,"last");}));},_eventSetup:function(){dojo.connect(document,"touchmove",function(e){e.preventDefault();});dojo.connect(window,"resize",this,function(){this._updateViewport();dojo.publish("/window/resize");});dojo.connect(document,"menubutton",this,function(e){e.preventDefault();dojo.publish("/button/menu");});dojo.connect(document,"backbutton",this,function(e){e.preventDefault();mulberry.app.Router.back();});dojo.connect(document,"searchbutton",this,function(e){mulberry.app.Router.go("/search");e.preventDefault();});if(this.siblingNav){dojo.connect(this.siblingNav,"show",this,function(){dojo.addClass(this.body,"sibling-nav-visible");dojo.publish("/window/resize");});dojo.connect(this.siblingNav,"hide",this,function(){dojo.removeClass(this.body,"sibling-nav-visible");dojo.publish("/window/resize");});}},showPage:function(page,node){if(!page){throw new Error("mulberry.app.UI::showPage called without a page to show");}if(page.startup){var s=dojo.subscribe("/page/transition/end",function(){page.startup();dojo.unsubscribe(s);});}this.containers.viewport.set("content",page);this.currentPage=page;if(!this.siblingNav){return;}this.set("siblingNavVisible",true);this.siblingNav.set("node",node);},hideSplash:function(){var _194=dojo.byId("splash");if(_194){dojo.destroy(_194);}}});dojo.subscribe("/app/ready",function(){mulberry.app.UI=new mulberry.app.UI(mulberry.Device);mulberry.showPage=dojo.hitch(mulberry.app.UI,"showPage");});}if(!dojo._hasResource["dojo.hash"]){dojo._hasResource["dojo.hash"]=true;dojo.provide("dojo.hash");(function(){dojo.hash=function(hash,_195){if(!arguments.length){return _196();}if(hash.charAt(0)=="#"){hash=hash.substring(1);}if(_195){_197(hash);}else{location.href="#"+hash;}return hash;};var _198,_199,_19a,_19b=dojo.config.hashPollFrequency||100;function _19c(str,_19d){var i=str.indexOf(_19d);return (i>=0)?str.substring(i+1):"";};function _196(){return _19c(location.href,"#");};function _19e(){dojo.publish("/dojo/hashchange",[_196()]);};function _19f(){if(_196()===_198){return;}_198=_196();_19e();};function _197(hash){if(_199){if(_199.isTransitioning()){setTimeout(dojo.hitch(null,_197,hash),_19b);return;}var href=_199.iframe.location.href;var _1a0=href.indexOf("?");_199.iframe.location.replace(href.substring(0,_1a0)+"?"+hash);return;}location.replace("#"+hash);!_19a&&_19f();};function _1a1(){var ifr=document.createElement("iframe"),_1a2="dojo-hash-iframe",_1a3=dojo.config.dojoBlankHtmlUrl||dojo.moduleUrl("dojo","resources/blank.html");if(dojo.config.useXDomain&&!dojo.config.dojoBlankHtmlUrl){console.warn("dojo.hash: When using cross-domain Dojo builds,"+" please save dojo/resources/blank.html to your domain and set djConfig.dojoBlankHtmlUrl"+" to the path on your domain to blank.html");}ifr.id=_1a2;ifr.src=_1a3+"?"+_196();ifr.style.display="none";document.body.appendChild(ifr);this.iframe=dojo.global[_1a2];var _1a4,_1a5,_1a6,_1a7,_1a8,_1a9=this.iframe.location;function _1aa(){_198=_196();_1a4=_1a8?_198:_19c(_1a9.href,"?");_1a5=false;_1a6=null;};this.isTransitioning=function(){return _1a5;};this.pollLocation=function(){if(!_1a8){try{var _1ab=_19c(_1a9.href,"?");if(document.title!=_1a7){_1a7=this.iframe.document.title=document.title;}}catch(e){_1a8=true;console.error("dojo.hash: Error adding history entry. Server unreachable.");}}var hash=_196();if(_1a5&&_198===hash){if(_1a8||_1ab===_1a6){_1aa();_19e();}else{setTimeout(dojo.hitch(this,this.pollLocation),0);return;}}else{if(_198===hash&&(_1a8||_1a4===_1ab)){}else{if(_198!==hash){_198=hash;_1a5=true;_1a6=hash;ifr.src=_1a3+"?"+_1a6;_1a8=false;setTimeout(dojo.hitch(this,this.pollLocation),0);return;}else{if(!_1a8){location.href="#"+_1a9.search.substring(1);_1aa();_19e();}}}}setTimeout(dojo.hitch(this,this.pollLocation),_19b);};_1aa();setTimeout(dojo.hitch(this,this.pollLocation),_19b);};dojo.addOnLoad(function(){if("onhashchange" in dojo.global&&(!dojo.isIE||(dojo.isIE>=8&&document.compatMode!="BackCompat"))){_19a=dojo.connect(dojo.global,"onhashchange",_19e);}else{if(document.addEventListener){_198=_196();setInterval(_19f,_19b);}else{if(document.attachEvent){_199=new _1a1();}}}});})();}if(!dojo._hasResource["mulberry.app.Router"]){dojo._hasResource["mulberry.app.Router"]=true;dojo.provide("mulberry.app.Router");(function(d){d.declare("mulberry.app.Router",null,{QUERY_STRING_MATCHER:/\?([^#]*)$/,PATH_REPLACER:"([^/]+)",PATH_NAME_MATCHER:/:([\w\d]+)/g,_routes:[],_cache:{},_currentHash:null,_hasHistoryState:!!(history.pushState&&history.replaceState),init:function(){if(!this.defaultRoute){console.error("No default route provided to router.");throw new Error("No default route provided to router.");}var hash=window.location.hash.toString(),loc=hash.replace("#","")||this.defaultRoute.origRoute;this.go(loc);d.subscribe("/dojo/hashchange",this,"_handleHash");if(this._hasHistoryState){d.connect(window,"onpopstate",this,function(){var hash=window.location.hash.replace("#","");this._handleHash(hash);});}},go:function(loc,_1ac,_1ad){var hash=loc.replace("#",""),_1ae;if(this._hasHistoryState){history[_1ac?"replaceState":"pushState"](_1ad,null,"#"+hash);this._handleHash(hash);}else{window.location.hash=hash;this._handleHash(hash);}},back:function(){mulberry.app.UI.set("navDirection","back");history.back();},home:function(){mulberry.app.UI.set("navDirection","back");this.go("/home");},_handleHash:function(hash){if(hash===this._currentHash){console.log(">>> hash is a dupe, ignoring: "+hash);return;}this._currentHash=hash;mulberry.logSection("Handling "+hash);var _1af=this.currentRoute=this._lookupRoute(hash),_1b0,_1b1=true;hash=hash.replace("#","");if(!_1af){console.log("No route found for hash "+hash);this.go(this.defaultRoute.origRoute);return;}_1b0=this._parseParamsFromHash(hash);_1b0.pageState=window.history.state;_1af=d.mixin(_1af,{hash:hash});_1af.callback(_1b0,_1af);d.publish("/router/handleHash/after");mulberry.endLogSection("Handling "+hash);},_parseParamsFromHash:function(hash){var _1b2=hash.split("?"),path=_1b2[0],_1b3=_1b2[1],_1b4,_1b5,_1b6=decodeURIComponent,_1b7=this.currentRoute;_1b4=_1b3?d.mixin({},d.queryToObject(_1b3)):{};if((_1b5=_1b7.path.exec(this._routeablePath(path)))!==null){_1b5.shift();d.forEach(_1b5,function(_1b8,i){if(_1b7.paramNames[i]){_1b4[_1b7.paramNames[i]]=_1b6(_1b8);}else{if(!_1b4.splat){_1b4.splat=[];}_1b4.splat.push(_1b6(_1b8));}});}return _1b4;},_lookupRoute:function(hash){if(!this._cache[hash]){d.forEach(this._routes,function(_1b9){if(this._routeablePath(hash).match(_1b9.path)){this._cache[hash]=_1b9;}},this);}return this._cache[hash];},_routeablePath:function(hash){return hash.replace(this.QUERY_STRING_MATCHER,"");},registerRoute:function(_1ba,fn,_1bb){var _1bc,_1bd=[],_1be=_1ba,r;this.PATH_NAME_MATCHER.lastIndex=0;while((_1bc=this.PATH_NAME_MATCHER.exec(_1ba))!==null){_1bd.push(_1bc[1]);}_1ba=d.isString(_1ba)?new RegExp("^"+_1ba.replace(this.PATH_NAME_MATCHER,this.PATH_REPLACER)+"$"):_1ba;r={origRoute:_1be,path:_1ba,callback:fn,paramNames:_1bd};this._routes.push(r);if(_1bb){this.defaultRoute=r;}this._cache={};}});mulberry.app.Router=new mulberry.app.Router();mulberry.route=function(_1bf,_1c0,_1c1){mulberry.app.Router.registerRoute(_1bf,_1c0,_1c1);};mulberry.routes=function(_1c2){dojo.forEach(_1c2,function(r){mulberry.app.Router.registerRoute(r.route,r.handler,r.isDefault);});};}(dojo));}if(!dojo._hasResource["mulberry.ui.BackgroundImage"]){dojo._hasResource["mulberry.ui.BackgroundImage"]=true;dojo.provide("mulberry.ui.BackgroundImage");dojo.declare("mulberry.ui.BackgroundImage",dijit._Widget,{imageUrl:"",isLoaded:false,loadOnInit:false,postCreate:function(){this.inherited(arguments);if(this.loadOnInit){this.loadImage();}},loadImage:function(){if(this.isLoaded){return;}dojo.style(this.domNode,{"backgroundImage":"url("+this.imageUrl+")","backgroundRepeat":"no-repeat"});this.isLoaded=true;},unloadImage:function(){dojo.style(this.domNode,"backgroundImage",null);this.isLoaded=false;},_setBackgroundImageAttr:function(_1c3){if(!_1c3){return;}this.imageUrl=_1c3.url;}});}if(!dojo._hasResource["mulberry.containers._LayoutBox"]){dojo._hasResource["mulberry.containers._LayoutBox"]=true;dojo.provide("mulberry.containers._LayoutBox");dojo.declare("mulberry.containers._LayoutBox",[mulberry._View,mulberry.ui.BackgroundImage],{templateString:"<div class=layout-box></div>",defaultConfig:{scrollable:false},postMixInProperties:function(){this.config=dojo.mixin(dojo.mixin({},this.defaultConfig),this.config);},postCreate:function(){this.inherited(arguments);if(this.config.className){this.addClass(this.config.className);}if(this.config.backgroundImage&&this.backgroundImage){this.loadImage();}}});}if(!dojo._hasResource["mulberry.containers.Region"]){dojo._hasResource["mulberry.containers.Region"]=true;dojo.provide("mulberry.containers.Region");(function(){mulberry.components=mulberry.components||{};var _1c4=[mulberry.components];dojo.declare("mulberry.containers.Region",mulberry.containers._LayoutBox,{templateString:dojo.cache("mulberry.containers","Region/Region.haml",".region\n  .pane{ dojoAttachPoint : 'pane' }\n    .inner{ dojoAttachPoint : 'inner' }\n"),config:{},_scroller:null,postCreate:function(){this.inherited(arguments);this._placeComponents();this._placeRegions();this._setupScroller();this.connect(this.screen,"startup","startup");},_setupScroller:function(){if(this.config.scrollable){this._scroller=new mulberry.ui.Scrollable({},this.pane);this.connect(this._scroller,"onScrollStart","onScrollStart");this.connect(this._scroller,"onScrollEnd","onScrollEnd");}},_placeComponents:function(){var _1c5=this.config.scrollable?[this.inner,"last"]:[this.pane,"replace"];if(this.config.components&&this.config.components.length>1&&_1c5[0]===this.pane){console.error("WARNING: you're trying to place more than one component into a non-scrollable region. this will end badly.");}if(this.config.components&&this.config.components.length){dojo.forEach(this.config.components,function(_1c6){var _1c7;if(_1c6.match(/^custom\./)){_1c7=client.components[_1c6.replace(/^custom\./,"")];}else{dojo.forEach(_1c4,function(ns){_1c7=ns[_1c6];});}if(!_1c7){console.error("No matching class found for",_1c6);}var c=this.adopt(_1c7,{baseObj:this.baseObj,page:this.page,node:this.baseObj,device:this.device,screen:this.screen,region:this});c.placeAt(_1c5[0],_1c5[1]);},this);}},_placeRegions:function(){var _1c8=this.config.scrollable?[this.inner,"last"]:[this.domNode];if(this.config.regions&&this.config.regions.length){if(!this.config.scrollable){dojo.destroy(this.pane);}dojo.forEach(this.config.regions,function(_1c9){this.adopt(mulberry.containers.Region,{config:_1c9,baseObj:this.baseObj,device:this.device,screen:this.screen,backgroundImage:this.backgroundImage}).placeAt(_1c8[0],_1c8[1]);},this);}},refreshScroller:function(){if(this._scroller){this._scroller.refreshScroller();}},onScrollStart:function(){},onScrollEnd:function(){}});mulberry.registerComponentNamespace=function(ns){_1c4.push(ns);};}());}if(!dojo._hasResource["mulberry.containers.Screen"]){dojo._hasResource["mulberry.containers.Screen"]=true;dojo.provide("mulberry.containers.Screen");dojo.declare("mulberry.containers.Screen",mulberry.containers._LayoutBox,{templateString:dojo.cache("mulberry.containers","Screen/Screen.haml",".screen\n"),components:{},postCreate:function(){this.inherited(arguments);this.addClass(this.config.name);if(this.config.regions){this.regions=dojo.map(this.config.regions,function(_1ca){return this.adopt(mulberry.containers.Region,{page:this.page,config:_1ca,baseObj:this.baseObj,device:this.device,screen:this,backgroundImage:this.backgroundImage}).placeAt(this.domNode);},this);}},registerComponent:function(c){var _1cb=c.declaredClass.split("."),_1cc=_1cb[_1cb.length-1];this.components[_1cc]=c;},getComponent:function(n){n=n.replace("custom.","");return this.components[n];}});}if(!dojo._hasResource["mulberry.containers.Page"]){dojo._hasResource["mulberry.containers.Page"]=true;dojo.provide("mulberry.containers.Page");(function(){mulberry.capabilities=mulberry.capabilities||{};var _1cd=[mulberry.capabilities];dojo.declare("mulberry.containers.Page",[mulberry._View,mulberry.ui.BackgroundImage],{pageDef:{},templateString:dojo.cache("mulberry.containers","Page/Page.haml","%li.page.node.configurable\n"),postMixInProperties:function(){this.inherited(arguments);this.baseObj.shareable=this.baseObj.type==="node";},postCreate:function(){this.screens={};if(!this.baseObj){throw "mulberry.Page requires a base object";}if(!this.pageDef.screens||!this.pageDef.screens.length){throw "The config for mulberry.Page must have at least one screen defined";}var _1ce=this.baseObj.pageBackground;dojo.forEach(this.pageDef.screens,function(_1cf){var scr=this.adopt(mulberry.containers.Screen,{page:this,config:_1cf,baseObj:this.baseObj,device:this.device,backgroundImage:_1ce}).placeAt(this.domNode);this.screens[_1cf.name]=scr;},this);this.capabilities=dojo.map(this.pageDef.capabilities||[],function(_1d0){var C=dojo.isObject(_1d0)?_1d0.name:_1d0,_1d1=_1d0.components,_1d2;dojo.forEach(_1cd,function(ns){_1d2=ns[C]||_1d2;});if(!_1d2){console.warn("No capability",C,"defined in these namespaces:");dojo.forEach(_1cd,function(ns){console.log("-- namespace",ns);},this);return null;}return new _1d2({page:this,baseObj:this.baseObj,components:_1d1});},this);if(this.screens.detail){this.screens.detail.hide();}this.addClass("page-"+this.baseObj.id);this.addClass(this.pageDefName);},showScreen:function(_1d3){dojo.forIn(this.screens,function(name,_1d4){if(name!==_1d3){_1d4.hide();}});this.screens[_1d3].show();},getScreen:function(_1d5){return this.screens[_1d5];},getComponent:function(_1d6){var c=false;this._components=this._components||{};if(!this._components[_1d6]){dojo.forIn(this.screens,function(_1d7,_1d8){var tmp=_1d8.getComponent(_1d6);if(tmp){c=tmp;}});this._components[_1d6]=c;}return this._components[_1d6];},startup:function(){this.inherited(arguments);dojo.forIn(this.screens,function(name,_1d9){_1d9.startup();});},init:function(){}});mulberry.registerCapabilityNamespace=function(ns){_1cd.push(ns);};}());}if(!dojo._hasResource["mulberry.app.PageFactory"]){dojo._hasResource["mulberry.app.PageFactory"]=true;dojo.provide("mulberry.app.PageFactory");dojo.declare("mulberry.app.PageFactory",null,{constructor:function(_1da){this.device=_1da;},createPage:function(obj){if(!obj){throw new Error("mulberry.app.PageFactory::createPage requires an object");}var _1db=obj.pageDef||"default",_1dc=mulberry.pageDefs[_1db];if(!_1dc){throw ("mulberry.app.PageFactory: The page definition \""+_1db+"\" does not exist.");}mulberry.log("Creating "+_1db);return new mulberry.containers.Page({baseObj:obj,device:this.device,pageDef:_1dc,pageDefName:_1db});}});dojo.subscribe("/app/ready",function(){mulberry.app.PageFactory=new mulberry.app.PageFactory(mulberry.Device);mulberry.createPage=dojo.hitch(mulberry.app.PageFactory,"createPage");});}if(!dojo._hasResource["mulberry.app.Notifications"]){dojo._hasResource["mulberry.app.Notifications"]=true;dojo.provide("mulberry.app.Notifications");(function(){var _1dd;mulberry.app.Notifications={areAvailable:function(){return !!mulberry.app.PhoneGap.present;},init:function(){if(!mulberry.app.PhoneGap.present){return;}window.plugins.pushNotification.startNotify();this._apnRegister();},setNotificationCallback:function(_1de){if(!mulberry.app.PhoneGap.present){return;}_1dd=window.plugins.pushNotification.notificationCallback=_1de;},notify:function(_1df){_1dd(_1df);},_apnRegister:function(){window.plugins.pushNotification.register(function(e){mulberry.app.Notifications._apnOnRegisterSuccess(e);},function(e){mulberry.app.Notifications._apnOnRegisterError(e);},[{alert:true,badge:true,sound:true}]);console.log("APN push notification registered.");},_apnOnRegisterSuccess:function(e){this._urbanAirshipRegister(e.deviceToken,e.host,e.appKey,e.appSecret);},_apnOnRegisterError:function(e){console.log("error registering with APN: "+e.toString());},_urbanAirshipRegister:function(_1e0,host,_1e1,_1e2){var _1e3=new XMLHttpRequest();_1e3.open("PUT",host+"api/device_tokens/"+_1e0,true,_1e1,_1e2);_1e3.onload=function(){if(this.status===200||this.status===201){console.log("Successfully registered with Urban Airship.");}else{console.log("Error when registring with Urban Airship: "+this.statusText);}};_1e3.send();}};var _1e4=mulberry.app.Notifications;dojo.subscribe("/app/ready",function(){var _1e5=function(){},_1e6="Notification from "+mulberry.app.Config.get("app").name;_1e4.init();_1e4.setNotificationCallback(function(_1e7){window.navigator.notification.alert(_1e7.alert,_1e5,_1e6);});});}());}if(!dojo._hasResource["mulberry.app.Has"]){dojo._hasResource["mulberry.app.Has"]=true;dojo.provide("mulberry.app.Has");mulberry.app.Has=function(){var _1e8=mulberry.Device;return {html5Player:function(){return _1e8.os!=="android";},iScrollZoom:function(){return _1e8.os!=="android";}};};(function(){var s=dojo.subscribe("/app/deviceready",function(){dojo.unsubscribe(s);if(dojo.isFunction(mulberry.app.Has)){mulberry.app.Has=mulberry.app.Has();}});}());}if(!dojo._hasResource["dojo.regexp"]){dojo._hasResource["dojo.regexp"]=true;dojo.provide("dojo.regexp");dojo.getObject("regexp",true,dojo);dojo.regexp.escapeString=function(str,_1e9){return str.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,function(ch){if(_1e9&&_1e9.indexOf(ch)!=-1){return ch;}return "\\"+ch;});};dojo.regexp.buildGroupRE=function(arr,re,_1ea){if(!(arr instanceof Array)){return re(arr);}var b=[];for(var i=0;i<arr.length;i++){b.push(re(arr[i]));}return dojo.regexp.group(b.join("|"),_1ea);};dojo.regexp.group=function(_1eb,_1ec){return "("+(_1ec?"?:":"")+_1eb+")";};}if(!dojo._hasResource["dojo.cookie"]){dojo._hasResource["dojo.cookie"]=true;dojo.provide("dojo.cookie");dojo.cookie=function(name,_1ed,_1ee){var c=document.cookie;if(arguments.length==1){var _1ef=c.match(new RegExp("(?:^|; )"+dojo.regexp.escapeString(name)+"=([^;]*)"));return _1ef?decodeURIComponent(_1ef[1]):undefined;}else{_1ee=_1ee||{};var exp=_1ee.expires;if(typeof exp=="number"){var d=new Date();d.setTime(d.getTime()+exp*24*60*60*1000);exp=_1ee.expires=d;}if(exp&&exp.toUTCString){_1ee.expires=exp.toUTCString();}_1ed=encodeURIComponent(_1ed);var _1f0=name+"="+_1ed,_1f1;for(_1f1 in _1ee){_1f0+="; "+_1f1;var _1f2=_1ee[_1f1];if(_1f2!==true){_1f0+="="+_1f2;}}document.cookie=_1f0;}};dojo.cookie.isSupported=function(){if(!("cookieEnabled" in navigator)){this("__djCookieTest__","CookiesAllowed");navigator.cookieEnabled=this("__djCookieTest__")=="CookiesAllowed";if(navigator.cookieEnabled){this("__djCookieTest__","",{expires:-1});}}return navigator.cookieEnabled;};}if(!dojo._hasResource["mulberry.app._Debug"]){dojo._hasResource["mulberry.app._Debug"]=true;dojo.provide("mulberry.app._Debug");(function(){var _1f3="http://api.toura.com/weinre/",sub=dojo.subscribe("/debug/user",function(_1f4){if(!mulberry.features.debugPage){return;}if(!confirm("Click OK if you want to enter debug mode.")){return;}mulberry.app.Router.go("/debug/"+_1f4);});var _1f5=function(){var _1f6=[],_1f7=2;while(_1f7--){_1f6.push((((1+Math.random())*65536)).toString(16).substring(0,3));}return "#m-"+_1f6.join("");};mulberry.app._Debug=function(){var _1f8=new mulberry.app._Debug.Tools().placeAt(dojo.body(),"first"),msg=new mulberry.app._Debug.Message().placeAt(dojo.body(),"first"),tpl="Debug &#64; {url} code: {hash}";dojo.connect(_1f8,"onWeinre",function(hash){msg.set("content",tpl.split("{url}").join(_1f3).split("{hash}").join(hash.slice(1)));});};mulberry.app._Debug.weinre={init:function(){var _1f9=dojo.cookie("debug-hash"),hash=_1f9||_1f5(),s=document.createElement("script"),url=s.src=this.script+hash;if(this.enabled){return hash;}window.WeinreServerURL=_1f3;document.body.appendChild(s);dojo.cookie("debug-hash",hash);this.enabled=true;return hash;},script:_1f3+"target/target-script-min.js",client:function(hash){return _1f3+"client/{hash}".replace("{hash}",hash);}};dojo.declare("mulberry.app._Debug.Tools",mulberry._Component,{templateString:"<div class=\"component debug-tools\"><div class=\"buttons\"></div></div>",actions:[{name:"Reset DB",method:"_resetDB"},{name:"weinre",method:"_weinre"}],postCreate:function(){this.inherited(arguments);this._makeActions();},_makeActions:function(){dojo.forEach(this.actions,function(_1fa){var n=dojo.create("div",{className:"button",innerHTML:_1fa.name});dojo.place(n,this.domNode.firstChild);this.connect(n,"click",_1fa.method);},this);},_resetDB:function(){mulberry.app.DeviceStorage.drop();window.location.reload();},_weinre:function(){if(this.hasWeinre){return;}var hash=mulberry.app._Debug.weinre.init();this.hasWeinre=true;this.onWeinre(hash);},onWeinre:function(hash){}});dojo.declare("mulberry.app._Debug.Message",mulberry._Component,{templateString:"<div class=\"component debug-message\"></div>",postCreate:function(){this.inherited(arguments);var n=dojo.create("div",{className:"close",innerHTML:"close"});dojo.place(n,this.domNode);this.connect(n,"click",function(){this.hide();});this.msgNode=dojo.create("div");dojo.place(this.msgNode,this.domNode);this.hide();},_setContentAttr:function(msg){this.show();this.msgNode.innerHTML=msg;}});}());}if(!dojo._hasResource["mulberry.components.Debug"]){dojo._hasResource["mulberry.components.Debug"]=true;dojo.provide("mulberry.components.Debug");dojo.declare("mulberry.components.Debug",mulberry._Component,{templateString:dojo.cache("mulberry.components","Debug/Debug.haml",".component.debug\n  .status{ dojoAttachPoint : 'status' }\n\n  %table{ dojoAttachPoint : 'deviceInfo' }\n\n  %ul.actions\n    %li{ dojoAttachEvent : 'click:_weinre' } weinre\n    %li{ dojoAttachEvent : 'click:_resetDB' } reset\n\n"),prepareData:function(){var html=[],tpl=function(k,v){return "<tr><th>{k}</th><td>{v}</td></tr>".replace("{k}",k).replace("{v}",v);},_1fb=function(t){return "<tr><th colspan=2>"+t+"</th></tr>";},k;html.push(_1fb("Device"));if(window.device){dojo.forIn(window.device,function(k,v){html.push(tpl(k,v));});}html.push(tpl("UA",window.navigator.userAgent));html.push(tpl("Device Type",this.device.type));html.push(tpl("Device OS",this.device.os));var app=mulberry.app.Config.get("app");html.push(_1fb("App"));html.push(tpl("Build Date",mulberry.app.Config.get("buildDate")));html.push(tpl("Data Version",mulberry.app.Tour._getLocalVersion()));dojo.forIn(app,function(k,v){html.push(tpl(k,v));});html.push(_1fb("Features"));dojo.forIn(mulberry.features,function(k,v){html.push(tpl(k,v?"true":"false"));});this.info=html.join("");this.inherited(arguments);},postCreate:function(){this.inherited(arguments);this.deviceInfo.innerHTML=this.info;},_weinre:function(){this.status.innerHTML="debugging at "+mulberry.app._Debug.weinre.init();dojo.publish("/content/update");},_resetDB:function(){mulberry.app.DeviceStorage.drop();window.location.reload();}});}if(!dojo._hasResource["mulberry.app._base"]){dojo._hasResource["mulberry.app._base"]=true;dojo.provide("mulberry.app._base");}if(!dojo._hasResource["mulberry.base"]){dojo._hasResource["mulberry.base"]=true;dojo.provide("mulberry.base");$m=mulberry;mulberry.version="0.3";var readyFn=function(){mulberry.features=mulberry.features||{};dojo.publish("/app/deviceready");dojo.subscribe("/app/ready",function(){mulberry.app.Router.init();mulberry.app.UI.hideSplash();});if(mulberry.features&&mulberry.features.debugToolbar){mulberry.app._Debug();}};document.addEventListener("deviceready",function(){dojo.ready(readyFn);},false);}dojo.i18n._preloadLocalizations("mulberry.nls.base",["ROOT","en","en-us","xx"]);
